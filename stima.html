<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>B&B Clean — Stima</title>
  <meta name="description" content="Calcola una stima e trova il partner più vicino">
  <link rel="icon" href="/assets/img/favicon-32.png">
  <script src="/assets/js/theme.js"></script>
  <link rel="stylesheet" href="/assets/css/styles.css">
</head>
  <!-- FILE: /stima.html -->
<body data-page="stima">
<!-- FILE: /stima.html  (incolla PRIMA di </body>, nell’ordine) -->
<script src="/assets/js/stima-ui.js"></script>
<script src="/assets/js/top-banner.js"></script>

<body>
<header class="container nav">
  <div class="logo"><img src="/assets/img/bbclean-logo-primary.png" alt="B&B Clean" style="height:32px"></div>
  <nav id="main-nav">
    <a href="/index.html">Home</a>
    <a href="/stima.html" class="active">Stima</a>
    <a href="/prenota.html">Prenota</a>
    <a href="/partner.html" data-role="nav-partner-cta">Diventa partner</a>
    <a href="#" id="logout-link">Esci</a>
  </nav>
</header>

<main class="container">
  <h1>Stima trasparente</h1>
  <p class="muted">Inserisci i dati dell’immobile. Troveremo il partner più vicino e ti mostreremo una stima.</p>

  <section class="card">
    <div class="grid-2">
      <div>
        <label for="regione">Regione</label>
        <select id="regione">
          <option value="">Seleziona…</option>
          <option>Abruzzo</option><option>Basilicata</option><option>Calabria</option><option>Campania</option>
          <option>Emilia-Romagna</option><option>Friuli-Venezia Giulia</option><option>Lazio</option><option>Liguria</option>
          <option>Lombardia</option><option>Marche</option><option>Molise</option><option>Piemonte</option>
          <option>Puglia</option><option>Sardegna</option><option>Sicilia</option><option>Toscana</option>
          <option>Trentino-Alto Adige</option><option>Umbria</option><option>Valle d'Aosta</option><option>Veneto</option>
        </select>
      </div>
      <div>
        <label for="citta">Città</label>
        <input id="citta" list="citta-list" placeholder="Digita e scegli…">
        <datalist id="citta-list"></datalist>
      </div>
      <div><label for="indirizzo">Indirizzo</label><input id="indirizzo" placeholder="Via/Piazza"></div>
      <div><label for="civico">Civico</label><input id="civico" placeholder="es. 12" inputmode="numeric"></div>
      <div><label for="mq">Metri quadrati</label><input id="mq" type="number" min="20" step="5" placeholder="es. 70"></div>
    </div>
    <button id="calcola" class="btn">Trova partner e calcola stima</button>
    <p id="msg" class="muted" style="margin-top:8px;"></p>
  </section>

  <section id="risultato" class="card" style="display:none">
    <h3>Risultato</h3>
    <div class="row" style="gap:12px;align-items:center;">
      <img id="partner-avatar" alt="Avatar" style="width:48px;height:48px;border-radius:50%;object-fit:cover;display:none;">
      <div>
        <div>Partner: <strong id="partner-name">—</strong> <span id="partner-pid" class="muted"></span></div>
        <div>Distanza: <span id="partner-dist">—</span> km</div>
      </div>
    </div>
    <hr>
    <div class="grid-2">
      <div>
        <div>Tariffa oraria: <strong id="rate-label">—</strong></div>
        <div>Durata stimata: <strong id="durata-label">—</strong></div>
        <div>Totale stimato: <strong id="totale-label">—</strong></div>
      </div>
      <div style="text-align:right"><a id="vai-prenota" class="btn">Procedi alla prenotazione</a></div>
    </div>
  </section>
</main>

<script src="/assets/js/vendor/auth0-spa-js.production.js"></script>
<script src="/assets/js/auth-config.js"></script>
<script src="/assets/js/auth.js"></script>
<script src="/assets/js/menu-auth.js"></script>
<script src="/assets/js/geo.js"></script>
<script>
const euro = v => (v===null||isNaN(v)) ? '—' : new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(v);
let SETTINGS = { m2_per_hour: 35, default_hourly_eur: 20 };

(async function init(){
  await fillComuniDatalist('citta-list');
})();

function msg(t){ document.getElementById('msg').textContent = t||''; }
function haversine(lat1, lon1, lat2, lon2){
  const R=6371, toRad = d => d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
async function loadPartners(){ const r=await fetch('/assets/data/partner.json',{cache:'no-store'}); return r.json(); }
async function publicPartner(pid){ const r=await fetch('/.netlify/functions/public-partner-get?pid='+encodeURIComponent(pid),{cache:'no-store'}); if(!r.ok) return null; return r.json(); }
function durataConsigliata(mq){ if(!mq||mq<=0) return 1; const ore = mq/(SETTINGS.m2_per_hour||35); return Math.max(1, Math.round(ore*2)/2); }

document.getElementById('calcola').addEventListener('click', async ()=>{
  msg('Geocodifica in corso…');
  const regione = document.getElementById('regione').value.trim();
  const citta = document.getElementById('citta').value.trim();
  const indirizzo = document.getElementById('indirizzo').value.trim();
  const civico = document.getElementById('civico').value.trim();
  const mq = Number(document.getElementById('mq').value);
  if (!regione || !citta || !indirizzo || !civico || !mq){ msg('Compila tutti i campi.'); return; }
  const geo = await geocodeViaNominatim(`${indirizzo} ${civico}`, citta, regione);
  if (!geo){ msg('Indirizzo non trovato.'); return; }

  msg('Calcolo partner più vicino…');
  const partners = await loadPartners();
  let best = null, bestDist = Infinity;
  partners.forEach(p=>{
    if (p.lat!=null && p.lon!=null){
      const d = haversine(geo.lat, geo.lon, Number(p.lat), Number(p.lon));
      if (d < bestDist){ bestDist = d; best = p; }
    }
  });
  if (!best){ msg('Nessun partner disponibile.'); return; }

  msg('Lettura tariffa partner…');
  const pub = await publicPartner(best.pid || best.partner_id || best.id || '');
  let hourly = pub?.hourly_eur;
  const nickname = pub?.nickname || best.nome_visibile || 'B&B Cleaner';
  const avatar = pub?.avatar_url || '/assets/img/bbclean-icon-128.png';
  if (!hourly){ hourly = SETTINGS.default_hourly_eur; }

  const ore = durataConsigliata(mq);
  const totale = hourly * ore;

  document.getElementById('risultato').style.display = '';
  const av = document.getElementById('partner-avatar'); av.src = avatar; av.style.display='block';
  document.getElementById('partner-name').textContent = nickname;
  document.getElementById('partner-pid').textContent = '(' + (best.pid || best.partner_id || 'pid') + ')';
  document.getElementById('partner-dist').textContent = bestDist.toFixed(1);
  document.getElementById('rate-label').textContent = euro(hourly);
  document.getElementById('durata-label').textContent = ore.toFixed(1) + ' h';
  document.getElementById('totale-label').textContent = euro(totale);

  const qp = new URLSearchParams({
    pid: (best.pid || best.partner_id || ''),
    regione, citta, indirizzo, civico, mq: String(mq),
    lat: String(geo.lat), lon: String(geo.lon),
    hourly: String(hourly), ore: String(ore), stima: String(totale)
  }).toString();
  document.getElementById('vai-prenota').href = '/prenota.html?'+qp;
  msg('');
});

document.getElementById('logout-link').addEventListener('click', (e)=>{ e.preventDefault(); window.authLogout && window.authLogout(); });
</script>
<script src="/assets/js/top-banner.js"></script>
<script src="/assets/js/back-arrow.js"></script>
</body>
</html>
  <!-- FOOTER -->
  <footer class="footer">
    <div class="container">
      © 2025 B&B Clean — Il tuo tempo è il nostro lavoro!
    </div>
  </footer>
