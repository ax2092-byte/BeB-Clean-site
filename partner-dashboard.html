<!-- FILE: /partner-dashboard.html  (NUOVO - dashboard partner protetta) -->
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Area Partner — Dashboard</title>
  <meta name="description" content="Gestisci il tuo profilo partner, zona di lavoro e prezzi extra.">
  <link rel="icon" href="/assets/img/favicon-32.png">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <style>
    :root{--brand:#0f9e9e;--brand-ink:#0a6f6f;--ink:#111827;--muted:#6b7280;--ring:#e5e7eb;--card:#f9fafb;--surface:#fff}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;color:var(--ink);background:var(--surface)}
    .container{width:min(1100px,92%);margin:0 auto}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
    .topbar .left{display:flex;align-items:center;gap:10px}
    .back-arrow{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:999px;border:1px solid var(--ring);text-decoration:none;color:var(--ink)}
    .back-arrow:hover{background:#f3f4f6}
    .logo{height:32px;display:block}
    .mainnav a{text-decoration:none;color:var(--ink);font-weight:700;margin-left:16px;padding:8px 12px;border-radius:12px}
    .mainnav a:hover{background:#f3f4f6}
    .mainnav a.active{background:#e6f5f5;color:var(--brand-ink)}
    .hero{padding:28px 0 8px}
    .hero h1{font-size:clamp(24px,4vw,32px);margin:0 0 6px}
    .sub{color:var(--muted);margin:0}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:18px}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .field label{display:block;margin:8px 0 6px;font-weight:600}
    .field input,.field select,.field textarea{width:100%;padding:12px;border:1px solid var(--ring);border-radius:12px}
    .field textarea{min-height:100px;resize:vertical}
    .btn{display:inline-block;border:1px solid var(--ring);padding:12px 16px;border-radius:14px;text-decoration:none;font-weight:700}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .muted{color:var(--muted)}
    .verified{font-size:12px;color:#065f46;background:#d1fae5;border:1px solid #10b981;padding:4px 8px;border-radius:999px;display:none}
  </style>
</head>
<body>
  <header class="topbar container" role="banner">
    <div class="left">
      <a id="back-link" class="back-arrow" href="#back" aria-label="Torna alla pagina precedente">←</a>
      <a href="/index.html" aria-label="B&B Clean — Home">
        <img class="logo" src="/assets/img/bbclean-logo-primary.png" alt="B&B Clean">
      </a>
    </div>
    <nav class="mainnav" aria-label="Menu principale">
      <a href="/index.html" data-page="home">HOME</a>
      <a href="/prenota.html" data-page="prenota">PRENOTA</a>
      <a href="/servizi.html" data-page="servizi">I NOSTRI SERVIZI</a>
      <a href="/partner.html" data-page="partner" class="active">DIVENTA PARTNER</a>
    </nav>
  </header>

  <section class="hero container">
    <h1>Dashboard Partner</h1>
    <p class="sub">Aggiorna i tuoi dati, zona di lavoro e prezzi extra consigliati o personalizzati.</p>
  </section>

  <main class="container" style="margin-bottom:28px">
    <!-- FORM NETLIFY: salvataggio profilo partner -->
    <form id="partner-form" class="card"
          name="partner_profile"
          method="POST"
          action="/success.html"
          data-netlify="true"
          netlify-honeypot="bot-field">
      <input type="hidden" name="form-name" value="partner_profile">
      <input type="hidden" name="bot-field">

      <!-- hidden tecnici -->
      <input type="hidden" name="partner_id" id="nf-partner-id">
      <input type="hidden" name="email" id="nf-email">
      <input type="hidden" name="lat" id="nf-lat">
      <input type="hidden" name="lon" id="nf-lon">

      <h2 class="h5" style="margin:4px 0 10px">Dati pubblici</h2>
      <div class="grid-3">
        <div class="field">
          <label for="attivita">Nome attività</label>
          <input type="text" id="attivita" name="attivita" placeholder="Es. B&B Clean Nuoro" required>
        </div>
        <div class="field">
          <label for="telefono">Telefono</label>
          <input type="tel" id="telefono" name="telefono" placeholder="+39 3xx xxx xxxx">
        </div>
        <div class="field">
          <label for="email_visibile">Email contatto (mostrata ai clienti)</label>
          <input type="email" id="email_visibile" name="email_visibile" placeholder="esempio@email.it">
        </div>
      </div>
      <div class="field">
        <label for="bio">Descrizione breve</label>
        <textarea id="bio" name="bio" placeholder="Chi sei, esperienza, particolarità del servizio…"></textarea>
      </div>

      <h2 class="h5" style="margin:16px 0 10px">Zona di lavoro</h2>
      <div class="grid-3">
        <div class="field">
          <label for="regione">Regione</label>
          <select id="regione" name="regione" required>
            <option value="">Seleziona…</option>
            <option>Abruzzo</option><option>Basilicata</option><option>Calabria</option><option>Campania</option>
            <option>Emilia-Romagna</option><option>Friuli-Venezia Giulia</option><option>Lazio</option><option>Liguria</option>
            <option>Lombardia</option><option>Marche</option><option>Molise</option><option>Piemonte</option>
            <option>Puglia</option><option>Sardegna</option><option>Sicilia</option><option>Toscana</option>
            <option>Trentino-Alto Adige</option><option>Umbria</option><option>Valle d'Aosta</option><option>Veneto</option>
          </select>
        </div>
        <div class="field">
          <label for="citta">Città</label>
          <input list="comuni-list" id="citta" name="citta" placeholder="Es. Nuoro" required>
          <datalist id="comuni-list"></datalist>
        </div>
        <div class="field">
          <label for="raggio">Raggio servizio (km)</label>
          <input type="number" id="raggio" name="service_radius_km" min="1" max="200" step="1" placeholder="Es. 25" required>
        </div>
      </div>

      <div class="grid-3">
        <div class="field">
          <label for="indirizzo">Indirizzo</label>
          <input type="text" id="indirizzo" name="indirizzo" placeholder="Es. Via Roma" required>
        </div>
        <div class="field">
          <label for="civico">Numero civico</label>
          <input type="text" id="civico" name="civico" placeholder="Es. 10" required>
        </div>
        <div class="field">
          <label>Verifica indirizzo</label>
          <div>
            <button id="btn-verify" class="btn" type="button">Verifica e imposta coordinate</button>
            <span id="verified" class="verified">Coordinate impostate ✓</span>
          </div>
        </div>
      </div>

      <h2 class="h5" style="margin:16px 0 10px">Prezzi extra personalizzati</h2>
      <div class="grid-3">
        <div class="field"><label for="p_biancheria">Cambio biancheria (€)</label><input type="number" step="0.5" id="p_biancheria" name="extra_cambio_biancheria" placeholder="Consigliato 4"></div>
        <div class="field"><label for="p_forno">Forno (€)</label><input type="number" step="0.5" id="p_forno" name="extra_forno" placeholder="Consigliato 7.5"></div>
        <div class="field"><label for="p_frigo">Frigo (€)</label><input type="number" step="0.5" id="p_frigo" name="extra_frigo" placeholder="Consigliato 6"></div>
        <div class="field"><label for="p_vetri">Vetri e infissi (€)</label><input type="number" step="0.5" id="p_vetri" name="extra_vetri" placeholder="Consigliato 8"></div>
        <div class="field"><label for="p_balconi">Balconi / verande (€)</label><input type="number" step="0.5" id="p_balconi" name="extra_balconi" placeholder="Consigliato 12"></div>
      </div>

      <div class="field">
        <label for="disponibilita">Disponibilità (note)</label>
        <textarea id="disponibilita" name="disponibilita" placeholder="Es. Disponibile lun–sab; mattina preferibile; ferie ad agosto…"></textarea>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
        <button type="submit" id="btn-save" class="btn primary">Salva profilo partner</button>
        <a href="/partner.html" class="btn">Torna a Diventa Partner</a>
      </div>
    </form>
  </main>

  <footer class="container" style="border-top:1px solid var(--ring);padding:16px 0;color:var(--muted);font-size:14px">
    © 2025 B&B Clean — Il tuo tempo è il nostro lavoro!
  </footer>

  <!-- Script comune -->
  <script src="/assets/js/site.js" defer></script>

  <!-- Auth0 + guard partner + stato utente -->
  <script src="/assets/js/vendor/auth0-spa-js.production.js"></script>
  <script src="/assets/js/auth-config.js"></script>
  <script src="/assets/js/auth.js"></script>
  <script src="/assets/js/guard-partner.js"></script>
  <script src="/assets/js/menu-auth.js"></script>

  <!-- Prefill + comuni + geocode -->
  <script>
    (function(){
      const $ = s => document.querySelector(s);

      const back = document.getElementById('back-link');
      if (back){
        back.addEventListener('click', function(e){
          e.preventDefault();
          if (history.length > 1) history.back();
          else location.href = '/partner.html';
        });
      }

      async function geocode(fullAddress){
        const url = '/.netlify/functions/geocode?q=' + encodeURIComponent(fullAddress);
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('Geocode fallito');
        return res.json();
      }

      async function loadComuni(){
        let data = null;
        for (const path of ['/assets/data/comuni.json','/comuni.json']){
          try{
            const res = await fetch(path, {cache:'no-store'});
            if (res.ok){ data = await res.json(); break; }
          }catch(_){}
        }
        if (!Array.isArray(data)) return;
        const dl = document.getElementById('comuni-list');
        const frag = document.createDocumentFragment();
        data.forEach(c=>{
          const opt = document.createElement('option');
          opt.value = (c.nome || c.Nome || '').toString();
          const prov = (c.provincia || c.Provincia || '').toString();
          if (prov) opt.setAttribute('label', opt.value + ' (' + prov + ')');
          frag.appendChild(opt);
        });
        dl.innerHTML = '';
        dl.appendChild(frag);
      }

      async function prefill(){
        await window.Auth.ensureReady();
        const user = await window.Auth.getUser();
        const email = (user && user.email) || '';
        const partnerId = (user && user.app_metadata && (user.app_metadata.partner_id||user.app_metadata.partnerId)) || (user && user.sub) || '';

        document.getElementById('nf-email').value = email;
        document.getElementById('nf-partner-id').value = String(partnerId);

        try{
          const res = await fetch('/assets/data/partner.json', {cache:'no-store'});
          const partners = await res.json();
          const p = Array.isArray(partners)
            ? partners.find(x => String(x.id||x.ID||x.slug||'') === String(partnerId) || (x.email && x.email===email))
            : null;
          if (p){
            if (p.attivita || p.nome) document.getElementById('attivita').value = p.attivita || p.nome;
            if (p.telefono) document.getElementById('telefono').value = p.telefono;
            if (p.email) document.getElementById('email_visibile').value = p.email;
            if (p.bio) document.getElementById('bio').value = p.bio;

            if (p.regione) document.getElementById('regione').value = p.regione;
            if (p.citta) document.getElementById('citta').value = p.citta;
            if (p.indirizzo) document.getElementById('indirizzo').value = p.indirizzo;
            if (p.civico) document.getElementById('civico').value = p.civico;

            if (p.service_radius_km) document.getElementById('raggio').value = p.service_radius_km;
            if (p.lat) document.getElementById('nf-lat').value = p.lat;
            if (p.lon || p.lng) document.getElementById('nf-lon').value = p.lon || p.lng;
            if (p.lat && (p.lon||p.lng)) { const v=document.getElementById('verified'); if (v) v.style.display='inline-block'; }

            const ep = p.extra_prices || p.extras || {};
            if (ep.cambio_biancheria != null) document.getElementById('p_biancheria').value = ep.cambio_biancheria;
            if (ep.forno != null) document.getElementById('p_forno').value = ep.forno;
            if (ep.frigo != null) document.getElementById('p_frigo').value = ep.frigo;
            if (ep.vetri != null) document.getElementById('p_vetri').value = ep.vetri;
            if (ep.balconi != null) document.getElementById('p_balconi').value = ep.balconi;
          } else {
            if (user && (user.name || user.nickname)) document.getElementById('attivita').value = user.name || user.nickname;
            if (email) document.getElementById('email_visibile').value = email;
          }
        }catch(_){}
      }

      document.addEventListener('DOMContentLoaded', async ()=>{
        await loadComuni();
        await prefill();

        document.getElementById('btn-verify').addEventListener('click', async ()=>{
          const regione = document.getElementById('regione').value.trim();
          const citta = document.getElementById('citta').value.trim();
          const indirizzo = document.getElementById('indirizzo').value.trim();
          const civico = document.getElementById('civico').value.trim();
          if (!regione || !citta || !indirizzo || !civico){
            alert('Compila Regione, Città, Indirizzo e Civico prima di verificare.');
            return;
          }
          const full = `${indirizzo} ${civico}, ${citta}, ${regione}, Italia`;
          try{
            const g = await geocode(full);
            document.getElementById('nf-lat').value = g.lat || '';
            document.getElementById('nf-lon').value = g.lon || '';
            const v = document.getElementById('verified'); if (v) v.style.display='inline-block';
          }catch(_){
            alert('Non sono riuscito a verificare l’indirizzo. Riprova.');
          }
        });

        document.getElementById('partner-form').addEventListener('submit', async (e)=>{
          e.preventDefault();
          document.getElementById('btn-save').disabled = true;

          if (!document.getElementById('nf-lat').value || !document.getElementById('nf-lon').value){
            const regione = document.getElementById('regione').value.trim();
            const citta = document.getElementById('citta').value.trim();
            const indirizzo = document.getElementById('indirizzo').value.trim();
            const civico = document.getElementById('civico').value.trim();
            if (regione && citta && indirizzo && civico){
              const full = `${indirizzo} ${civico}, ${citta}, ${regione}, Italia`;
              try{
                const g = await geocode(full);
                document.getElementById('nf-lat').value = g.lat || '';
                document.getElementById('nf-lon').value = g.lon || '';
                const v = document.getElementById('verified'); if (v) v.style.display='inline-block';
              }catch(_){
                alert('Non sono riuscito a verificare l’indirizzo. Controlla i dati e riprova.');
                document.getElementById('btn-save').disabled = false;
                return;
              }
            } else {
              alert('Compila Regione, Città, Indirizzo, Civico e verifica l’indirizzo.');
              document.getElementById('btn-save').disabled = false;
              return;
            }
          }

          e.target.submit();
        });
      });
    })();
  </script>
</body>
</html>
