<!DOCTYPE html>
<html lang="it"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>App Partner — QR & Timer — B&amp;B Clean</title>
<link rel="icon" type="image/png" href="favicon.png">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script></head>
<body class="p-6">
  <p><a class="underline" href="partner.html">← Torna a Diventa Partner</a></p>
  <h1 class="text-2xl font-bold mt-2">QR Start/Stop + Timer</h1>
  <p class="text-sm">MVP dimostrativo: QR + Timer + calcolo ore pagate.</p>
  <video id="video" class="mt-3 w-full max-w-md bg-black" playsinline></video>
  <canvas id="canvas" class="hidden"></canvas>
  <div class="mt-3 flex flex-wrap gap-2">
    <button id="btnStartScan" class="bg-blue-600 text-white px-3 py-1 rounded">Avvia scansione</button>
    <button id="btnStopScan" class="border px-3 py-1 rounded">Ferma scansione</button>
    <input id="manualCode" placeholder="Codice QR" class="border p-2 rounded">
    <button id="btnUseCode" class="border px-3 py-1 rounded">Usa codice</button>
  </div>
  <div class="mt-2 text-sm">Ultimo QR: <span id="qrOut" class="font-mono"></span></div>
  <div class="mt-4">
    <div class="text-3xl font-bold"><span id="timer">00:00:00</span></div>
    <div class="mt-2 flex gap-2">
      <button id="btnStart" class="bg-emerald-600 text-white px-3 py-1 rounded">START (QR)</button>
      <button id="btnStop" class="bg-rose-600 text-white px-3 py-1 rounded">STOP (QR)</button>
    </div>
    <div id="status" class="text-sm mt-2"></div>
  </div>
  <script>
    const video=document.getElementById('video');const canvas=document.getElementById('canvas');const ctx=canvas.getContext('2d');
    const qrOut=document.getElementById('qrOut');const manualCode=document.getElementById('manualCode');
    const btnUseCode=document.getElementById('btnUseCode');const btnStartScan=document.getElementById('btnStartScan');const btnStopScan=document.getElementById('btnStopScan');
    let scanning=false;let lastQR='';
    btnStartScan.addEventListener('click',async()=>{try{const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});video.srcObject=stream;await video.play();scanning=true;scanFrame();}catch(e){alert('No camera: '+e.message);}});
    btnStopScan.addEventListener('click',()=>{scanning=false;if(video.srcObject){video.srcObject.getTracks().forEach(t=>t.stop());}video.srcObject=null;});
    btnUseCode.addEventListener('click',()=>{if(manualCode.value.trim()){lastQR=manualCode.value.trim();qrOut.textContent=lastQR;}});
    async function scanFrame(){if(!scanning)return;canvas.width=video.videoWidth;canvas.height=video.videoHeight;ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);const code=jsQR(imageData.data,canvas.width,canvas.height);if(code){lastQR=code.data;qrOut.textContent=lastQR;}requestAnimationFrame(scanFrame);}
    const timerEl=document.getElementById('timer');const statusEl=document.getElementById('status');let startTs=null;let stopTs=null;let id=null;
    function fmt(ms){const s=Math.floor(ms/1000);const h=String(Math.floor(s/3600)).padStart(2,'0');const m=String(Math.floor((s%3600)/60)).padStart(2,'0');const sec=String(s%60).padStart(2,'0');return `${h}:${m}:${sec}`;}
    function quarter(mins){if(mins<=0)return 0;const q=Math.round(mins/15)*15;return q===0?15:q;}
    btnStart.addEventListener('click',()=>{if(!lastQR){alert('Prima scansiona o inserisci il codice.');return;}startTs=Date.now();stopTs=null;statusEl.textContent='Timer avviato.';if(id)clearInterval(id);id=setInterval(()=>{timerEl.textContent=fmt(Date.now()-startTs);},1000);});
    btnStop.addEventListener('click',()=>{if(!startTs){alert('Devi fare START prima.');return;}stopTs=Date.now();clearInterval(id);timerEl.textContent=fmt(stopTs-startTs);statusEl.textContent='Timer fermato.';
      const Tmins=Math.max(0,Math.round((stopTs-startTs)/60000));const paid=quarter(Tmins);const paidH=paid/60;const partnerPay=paidH*14.2;alert(`Tempo effettivo: ${(Tmins/60).toFixed(2)}h\nOre pagate: ${paidH.toFixed(2)}h\nCompenso partner: € ${partnerPay.toFixed(2)}`);
    });
  </script>
</body></html>
