<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>B&B Clean — Profilo</title>
  <link rel="icon" href="/favicon.png">
  <meta name="description" content="Gestisci il tuo profilo cliente B&B Clean.">
  <style>
    :root { --bg:#0b1220; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --brand:#14b8a6; --line:#1f2937; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 960px; margin: 0 auto; padding: 24px 16px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:20px; }
    h1 { margin:0 0 8px; }
    p.muted { color:var(--muted); margin:0 0 18px; }
    .row { display:grid; grid-template-columns: repeat(12,1fr); gap:12px; }
    .col-6 { grid-column: span 6; } .col-4 { grid-column: span 4; } .col-3 { grid-column: span 3; } .col-12 { grid-column: span 12; }
    label { display:block; font-size:14px; margin-bottom:4px; color:#cbd5e1; }
    input, select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0f172a; color:var(--text); }
    .hint { color:var(--muted); font-size:12px; margin-top:4px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center; }
    button, .btn { padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:transparent; color:#fff; cursor:pointer; text-decoration:none; }
    .btn-primary { background:var(--brand); border-color:var(--brand); color:#071820; }
    .btn-primary[disabled] { opacity:.6; cursor:not-allowed; }
    .ok { color:#86efac; font-size:12px; }
    .err { color:#fca5a5; white-space:pre-wrap; }
    .hidden { display:none !important; }
    @media (max-width:860px){ .col-6,.col-4,.col-3 { grid-column: span 12; } }
    .status { display:flex; gap:8px; align-items:center; font-size:14px; margin:6px 0; }
    .status .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .status.ok .dot { background:#22c55e; } .status.ko .dot{ background:#ef4444; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .need { color:#fca5a5; font-size:12px; }
  </style>
</head>

<!-- ATTIVA modalità profilo cliente -->
<body data-profile="client">

  <div class="wrap">
    <h1>Profilo</h1>
    <p class="muted">Completa i dati anagrafici.</p>

    <!-- login richiesta -->
    <div id="need-auth" class="card">
      <p>Per modificare il profilo, accedi al tuo account.</p>
      <div class="actions">
        <a id="cta-login" class="btn btn-primary" href="#">Accedi</a>
      </div>
      <p class="ok" id="diag"></p>
      <p class="err" id="err"></p>
    </div>

    <!-- profilo -->
    <div id="profile" class="card hidden">
      <h2>Dati account</h2>
      <div class="row">
        <div class="col-6">
          <label>Nome</label>
          <input id="first_name" readonly>
        </div>
        <div class="col-6">
          <label>Cognome</label>
          <input id="last_name" readonly>
        </div>
        <div class="col-6">
          <label>Email</label>
          <input id="email" class="mono" readonly>
          <div id="email_status" class="status"><span class="dot"></span><span></span></div>
        </div>
        <div class="col-6">
          <label>Telefono</label>
          <input id="phone" class="mono" readonly>
          <div id="phone_status" class="status"><span class="dot"></span><span></span></div>
        </div>
      </div>

      <h2 style="margin-top:14px;">Anagrafica</h2>
      <div class="row">
        <div class="col-4">
          <label for="sex">Sesso *</label>
          <select id="sex" required>
            <option value="">Seleziona…</option>
            <option value="M">Maschio</option>
            <option value="F">Femmina</option>
          </select>
        </div>
        <div class="col-4">
          <label for="birth_date">Data di nascita *</label>
          <input id="birth_date" type="date" required>
        </div>
        <div class="col-12">
          <label for="comune">Comune di nascita *</label>
          <input id="comune" list="comuni-list" placeholder="Es. ROMA (RM)" required autocomplete="off">
          <datalist id="comuni-list"></datalist>
          <input id="belfiore" type="hidden">
        </div>
        <div class="col-6">
          <label for="codice_fiscale">Codice Fiscale</label>
          <input id="codice_fiscale" class="mono" readonly>
          <div id="cf_need" class="need hidden"></div>
        </div>
      </div>

      <!-- Documenti (UI) -->
      <h2 style="margin-top:14px;">Documenti</h2>
      <div class="row">
        <div class="col-6">
          <label for="doc_type">Tipo documento *</label>
          <select id="doc_type">
            <option value="">Seleziona…</option>
            <option value="CI">Carta d'identità</option>
            <option value="PATENTE">Patente</option>
          </select>
        </div>
        <div class="col-6">
          <label for="doc_number">Numero documento *</label>
          <input id="doc_number" placeholder="AA1234567">
        </div>
        <div class="col-6">
          <label for="doc_expiry">Scadenza *</label>
          <input id="doc_expiry" type="date">
        </div>
      </div>

      <div class="row" style="margin-top:6px;">
        <div class="col-4">
          <label for="file_front">Fronte *</label>
          <input id="file_front" type="file" accept="image/*,application/pdf">
        </div>
        <div class="col-4">
          <label for="file_back">Retro *</label>
          <input id="file_back" type="file" accept="image/*,application/pdf">
        </div>
        <div class="col-4">
          <label for="file_selfie">Selfie con documento *</label>
          <input id="file_selfie" type="file" accept="image/*">
        </div>
      </div>

      <div class="actions">
        <button id="upload_docs" class="btn">Carica documenti</button>
        <span id="upload_msg" class="ok"></span>
        <span id="upload_err" class="err"></span>
      </div>

      <div class="actions">
        <button id="save" class="btn btn-primary" disabled>Salva</button>
        <span id="save_msg" class="ok"></span>
        <span id="save_err" class="err"></span>
      </div>
    </div>
  </div>

  <!-- Config + SDK (v2) -->
  <script src="/assets/js/auth0-config.js" defer></script>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js" defer></script>
  <script>if(typeof auth0==='undefined'){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/@auth0/auth0-spa-js@2.3.0/dist/auth0-spa-js.production.js';s.defer=true;document.head.appendChild(s);}</script>

  <script>
    // --- utils base ---
    const _deburr = s => (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    const U = s => _deburr(String(s)).toUpperCase().trim().replace(/\s+/g,' ');

    // ===== Codice Fiscale (Italia) =====
    const MONTH = {1:'A',2:'B',3:'C',4:'D',5:'E',6:'H',7:'L',8:'M',9:'P',10:'R',11:'S',12:'T'};
    const ODD = {'0':1,'1':0,'2':5,'3':7,'4':9,'5':13,'6':15,'7':17,'8':19,'9':21,
                 'A':1,'B':0,'C':5,'D':7,'E':9,'F':13,'G':15,'H':17,'I':19,'J':21,
                 'K':2,'L':4,'M':18,'N':20,'O':11,'P':3,'Q':6,'R':8,'S':12,'T':14,
                 'U':16,'V':10,'W':22,'X':25,'Y':24,'Z':23};
    const EVEN = {'0':0,'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,
                  'A':0,'B':1,'C':2,'D':3,'E':4,'F':5,'G':6,'H':7,'I':8,'J':9,
                  'K':10,'L':11,'M':12,'N':13,'O':14,'P':15,'Q':16,'R':17,'S':18,'T':19,
                  'U':20,'V':21,'W':22,'X':23,'Y':24,'Z':25};
    const CIN = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    function _isVowel(c){ return 'AEIOU'.includes(c); }
    function _cons(s){ return U(s).replace(/[^A-Z]/g,'').split('').filter(c => !_isVowel(c)).join(''); }
    function _vows(s){ return U(s).replace(/[^A-Z]/g,'').split('').filter(_isVowel).join(''); }
    function _codeSurname(s){ const c=_cons(s), v=_vows(s); return (c + v + 'XXX').slice(0,3); }
    function _codeName(s){ const c=_cons(s), v=_vows(s); return (c.length>=4) ? (c[0]+c[2]+c[3]) : (c + v + 'XXX').slice(0,3); }
    function _codeDate(birthDate, sex){
      const dt = new Date(birthDate); if (isNaN(dt)) return null;
      const yy = String(dt.getFullYear()).slice(-2), mm = MONTH[dt.getMonth()+1]; let dd = dt.getDate();
      if (sex === 'F') dd += 40; return yy + mm + String(dd).padStart(2,'0');
    }
    function _controlChar(code15){
      let sum = 0; for (let i=0;i<15;i++){ const ch=code15[i]; sum += (i%2===0) ? ODD[ch] : EVEN[ch]; }
      return CIN[sum % 26];
    }
    function buildCodiceFiscale({ name, surname, birthDate, sex, belfiore }){
      const S = U(surname), N = U(name), SEX=(sex||'').toUpperCase(), BF=(belfiore||'').toUpperCase();
      if (!S || !N || !birthDate || !SEX || !BF || BF.length !== 4) return '';
      const base = _codeSurname(S) + _codeName(N) + _codeDate(birthDate, SEX) + BF;
      if (!base || base.length !== 15) return '';
      return base + _controlChar(base);
    }

    (async function(){
      const wait = ms => new Promise(r => setTimeout(r, ms));
      // fallback CONFIG se mancasse
      setTimeout(()=>{
        if (typeof window.AUTH0_CONFIG === 'undefined') {
          const ORIGIN = location.origin;
          window.AUTH0_CONFIG = {
            domain: "dev-nmvv4fpc7jmiw1pw.eu.auth0.com",
            clientId: "Tpjl7J5RWMRm5WdGD8PCPTymMSFKiWmq",
            authorizationParams: { redirect_uri: ORIGIN },
            cacheLocation: "memory",
            useRefreshTokens: false
          };
        }
      },300);

      while (typeof auth0 === 'undefined' || typeof window.AUTH0_CONFIG === 'undefined') { await wait(30); }
      const client = await auth0.createAuth0Client(window.AUTH0_CONFIG);

      // callback cleanup
      if (location.search.includes('state=') && (location.search.includes('code=') || location.search.includes('error='))) {
        try { await client.handleRedirectCallback(); } catch(e) { console.warn(e); }
        history.replaceState({}, document.title, location.pathname);
      }

      const isAuth = await client.isAuthenticated();
      const $need = document.getElementById('need-auth');
      const $card = document.getElementById('profile');
      const $err  = document.getElementById('err');

      if (!isAuth) {
        document.getElementById('cta-login')?.addEventListener('click', async (e)=>{
          e.preventDefault();
          try { await client.loginWithPopup(); location.reload(); }
          catch (e) { $err.textContent = e.message || String(e); }
        });
        return;
      }

      // token per Functions
      const token = await client.getTokenSilently({ authorizationParams: { audience: 'https://bebclean.it/api' } });

      // mostra card profilo
      $need.classList.add('hidden'); $card.classList.remove('hidden');

      // utente da Auth0
      const user = await client.getUser();
      const emailVerified = !!user?.email_verified;
      const email = user?.email || '';
      const firstName = user?.given_name || (user?.name||'').split(' ')[0] || '';
      const lastName  = user?.family_name || (user?.name||'').split(' ').slice(1).join(' ') || '';

      // riempi campi readonly
      const $fn = document.getElementById('first_name');
      const $ln = document.getElementById('last_name');
      document.getElementById('email').value = email;
      $fn.value = firstName; $ln.value = lastName;

      const emailStatus = document.getElementById('email_status');
      emailStatus.classList.add(emailVerified ? 'ok' : 'ko');
      emailStatus.querySelector('span:last-child').textContent = emailVerified ? 'Email verificata' : 'Email NON verificata';

      // carica profilo da Supabase (per telefono verificato, ecc.)
      let prof = null;
      try {
        const r = await fetch('/.netlify/functions/profile-load', {
          headers: { 'authorization': 'Bearer ' + token }
        });
        prof = await r.json();
      } catch(e) { console.warn('profile-load error', e); }

      const phone = prof?.phone || '';
      const phoneVerified = !!prof?.phone_verified_at;
      document.getElementById('phone').value = phone || '(non impostato)';
      const phoneStatus = document.getElementById('phone_status');
      phoneStatus.classList.add(phoneVerified ? 'ok' : 'ko');
      phoneStatus.querySelector('span:last-child').textContent = phoneVerified ? 'Telefono verificato' : 'Telefono NON verificato';

      // --- Comuni: indici e datalist ---
      const comuni = await fetch('/assets/data/comuni.json').then(r=>r.json()).catch(()=>[]);
      const $list = document.getElementById('comuni-list');
      const byLabel = new Map();  // "ROMA (RM)" -> H501
      const byName  = new Map();  // "ROMA" -> [{code:'H501',prov:'RM'}, ...]
      const byCode  = new Set();  // "H501"

      for (const c of comuni) {
        const name = U(c.nome);
        const prov = U(c.provincia || '');
        const codeRaw = c.belfiore ?? c.codice ?? c.codice_belfiore ?? c.codiceCatastale ?? c.codice_catastale ?? '';
        const code = U(codeRaw).slice(0,4);
        const label = prov ? `${name} (${prov})` : name;

        const opt = document.createElement('option'); opt.value = label; $list.appendChild(opt);

        byLabel.set(label, code);
        if (!byName.has(name)) byName.set(name, []);
        byName.get(name).push({ code, prov });
        if (code) byCode.add(code);
      }

      // --- Ricalcolo CF & abilitazione SALVA ---
      const $sex = document.getElementById('sex');
      const $dob = document.getElementById('birth_date');
      const $com = document.getElementById('comune');
      const $bf  = document.getElementById('belfiore');
      const $cf  = document.getElementById('codice_fiscale');
      const $cfNeed = document.getElementById('cf_need');
      const $save = document.getElementById('save');

      function parseProv(raw){
        const q = U(raw);
        const m = q.match(/\(([A-Z]{2})\)\s*$/) || q.match(/\s([A-Z]{2})\s*$/);
        return m ? m[1] : '';
      }
      function findBelfiore(raw){
        const q = U(raw);
        if (!q) return '';
        if (byLabel.has(q)) return byLabel.get(q);
        if (byCode.has(q))  return q;
        const pr = parseProv(q);
        const baseName = q.replace(/\s*\([A-Z]{2}\)\s*$/,'').replace(/\s+[A-Z]{2}\s*$/,'');
        const arr = byName.get(baseName);
        if (arr && arr.length) {
          if (pr) { const hit = arr.find(a => a.prov === pr); if (hit) return hit.code; }
          if (arr.length === 1) return arr[0].code;
        }
        return '';
      }
      function updateSaveState(){
        const missing = [];
        if (!U($fn.value)) missing.push('Nome');
        if (!U($ln.value)) missing.push('Cognome');
        if (!$sex.value)   missing.push('Sesso');
        if (!$dob.value)   missing.push('Data di nascita');
        if (!$bf.value)    missing.push('Comune valido');
        if (!U($cf.value)) missing.push('Codice Fiscale');
        $cfNeed.classList.toggle('hidden', missing.length === 0);
        $cfNeed.textContent = missing.length ? ('Completa: ' + missing.join(', ')) : '';
        $save.disabled = missing.length > 0;
      }
      function recalcCF(){
        if (!$bf.value && $com.value) {
          const bf = findBelfiore($com.value);
          if (bf) $bf.value = bf;
        }
        const cf = buildCodiceFiscale({
          name: $fn.value, surname: $ln.value,
          birthDate: $dob.value, sex: $sex.value,
          belfiore: $bf.value
        });
        $cf.value = cf || '';
        const baseName = U($com.value).replace(/\s*\([A-Z]{2}\)\s*$/,'').replace(/\s+[A-Z]{2}\s*$/,'');
        const arr = byName.get(baseName);
        const ambiguous = baseName && arr && arr.length > 1 && !$bf.value;
        if (ambiguous) {
          $cfNeed.classList.remove('hidden');
          $cfNeed.textContent = 'Comune non univoco: aggiungi la provincia, es. "NOME (PR)".';
        }
        updateSaveState();
      }

      [$sex,$dob,$com].forEach(el => {
        el.addEventListener('change', recalcCF);
        el.addEventListener('input',  recalcCF);
        el.addEventListener('keyup',  recalcCF);
      });

      // tentativi iniziali in caso Nome/Cognome arrivino tardi dai claims
      let tries = 0; const ts = setInterval(() => {
        tries++; recalcCF(); if (tries > 30 || (U($fn.value) && U($ln.value))) clearInterval(ts);
      }, 300);
      recalcCF();

      // Salva anagrafica su Supabase via Function
      document.getElementById('save').addEventListener('click', async ()=>{
        document.getElementById('save_msg').textContent = '';
        document.getElementById('save_err').textContent = '';
        if ($save.disabled) return;

        try {
          const res = await fetch('/.netlify/functions/profile-save', {
            method: 'POST',
            headers: { 'content-type':'application/json', 'authorization':'Bearer '+token },
            body: JSON.stringify({
              birth_date: $dob.value,
              birth_place_code: $bf.value,
              codice_fiscale: $cf.value
            })
          });
          const json = await res.json();
          if (!res.ok || !json?.saved) throw new Error(json?.error || 'Errore salvataggio');
          document.getElementById('save_msg').textContent = 'Salvato!';
        } catch(e) {
          document.getElementById('save_err').textContent = e.message || String(e);
        }
      });

      // Pulsante "Carica documenti" (solo UI per ora)
      document.getElementById('upload_docs')?.addEventListener('click', (e)=>{
        e.preventDefault();
        document.getElementById('upload_err').textContent = '';
        document.getElementById('upload_msg').textContent = 'Upload documenti disponibile nel prossimo step.';
      });
    })();
  </script>

  <!-- Banner profilo (#0a8f8f) + freccia indietro -->
  <script src="/assets/js/top-banner.js"></script>
  <script src="/assets/js/back-arrow.js"></script>
</body>
</html>
