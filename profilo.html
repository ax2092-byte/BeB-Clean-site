<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>B&B Clean — Profilo</title>
  <link rel="icon" href="/favicon.png">
  <meta name="description" content="Gestisci il tuo profilo cliente B&B Clean.">
  <style>
    :root { --bg:#0b1220; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --brand:#14b8a6; --line:#1f2937; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 960px; margin: 0 auto; padding: 24px 16px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:20px; }
    h1 { margin:0 0 8px; }
    p.muted { color:var(--muted); margin:0 0 18px; }
    .row { display:grid; grid-template-columns: repeat(12,1fr); gap:12px; }
    .col-6 { grid-column: span 6; } .col-4 { grid-column: span 4; } .col-3 { grid-column: span 3; } .col-12 { grid-column: span 12; }
    label { display:block; font-size:14px; margin-bottom:4px; color:#cbd5e1; }
    input, select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0f172a; color:var(--text); }
    .hint { color:var(--muted); font-size:12px; margin-top:4px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button, .btn { padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:transparent; color:var(--text); cursor:pointer; text-decoration:none; }
    .btn-primary { background:var(--brand); border-color:var(--brand); color:#071820; }
    .ok { color:#86efac; font-size:12px; }
    .err { color:#fca5a5; white-space:pre-wrap; }
    .hidden { display:none !important; }
    @media (max-width:860px){ .col-6,.col-4,.col-3 { grid-column: span 12; } }
    .status { display:flex; gap:8px; align-items:center; font-size:14px; margin:6px 0; }
    .status .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .status.ok .dot { background:#22c55e; } .status.ko .dot{ background:#ef4444; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Profilo</h1>
    <p class="muted">Completa i dati anagrafici. Il Codice Fiscale viene calcolato automaticamente. Il Codice Belfiore è gestito in automatico e non è richiesto.</p>

    <!-- login richiesta -->
    <div id="need-auth" class="card">
      <p>Per modificare il profilo, accedi al tuo account.</p>
      <div class="actions">
        <a id="cta-login" class="btn btn-primary" href="#">Accedi</a>
      </div>
      <p class="ok" id="diag"></p>
      <p class="err" id="err"></p>
    </div>

    <!-- profilo -->
    <div id="profile" class="card hidden">
      <h2>Dati account</h2>
      <div class="row">
        <div class="col-6">
          <label>Nome</label>
          <input id="first_name" readonly>
        </div>
        <div class="col-6">
          <label>Cognome</label>
          <input id="last_name" readonly>
        </div>
        <div class="col-6">
          <label>Email</label>
          <input id="email" class="mono" readonly>
          <div id="email_status" class="status"><span class="dot"></span><span></span></div>
        </div>
        <div class="col-6">
          <label>Telefono</label>
          <input id="phone" class="mono" readonly>
          <div id="phone_status" class="status"><span class="dot"></span><span></span></div>
        </div>
      </div>

      <h2 style="margin-top:14px;">Anagrafica</h2>
      <div class="row">
        <div class="col-4">
          <label for="sex">Sesso *</label>
          <select id="sex" required>
            <option value="">Seleziona…</option>
            <option value="M">Maschio</option>
            <option value="F">Femmina</option>
          </select>
        </div>
        <div class="col-4">
          <label for="birth_date">Data di nascita *</label>
          <input id="birth_date" type="date" required>
        </div>
        <div class="col-12">
          <label for="comune">Comune di nascita *</label>
          <input id="comune" list="comuni-list" placeholder="Es. ROMA (RM)" required autocomplete="off">
          <datalist id="comuni-list"></datalist>
          <div class="hint">Digita e scegli dall’elenco. Il Codice Belfiore viene inserito automaticamente (nascosto).</div>
          <input id="belfiore" type="hidden">
        </div>
        <div class="col-6">
          <label for="codice_fiscale">Codice Fiscale (auto)</label>
          <input id="codice_fiscale" class="mono" readonly>
          <div class="hint">Viene calcolato da Nome, Cognome, Sesso, Data e Comune.</div>
        </div>
      </div>

      <div class="actions">
        <button id="save" class="btn btn-primary">Salva</button>
        <span id="save_msg" class="ok"></span>
        <span id="save_err" class="err"></span>
      </div>
    </div>
  </div>

  <!-- Config + SDK (v2) -->
  <script src="/assets/js/auth0-config.js" defer></script>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js" defer></script>
  <script>if(typeof auth0==='undefined'){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/@auth0/auth0-spa-js@2.3.0/dist/auth0-spa-js.production.js';s.defer=true;document.head.appendChild(s);}</script>

  <script>
    // Normalizzazione stringhe
    const slug = s => (s||'').toUpperCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
    // Codice Fiscale utilities
    const CF = (()=> {
      const VOW = c => 'AEIOU'.includes(c);
      const CONS = s => s.replace(/[^A-Z]/g,'').split('').filter(c=>!VOW(c)).join('');
      const VOWS = s => s.replace(/[^A-Z]/g,'').split('').filter(VOW).join('');
      const MONTH = {1:'A',2:'B',3:'C',4:'D',5:'E',6:'H',7:'L',8:'M',9:'P',10:'R',11:'S',12:'T'};
      const ODD = {'0':1,'1':0,'2':5,'3':7,'4':9,'5':13,'6':15,'7':17,'8':19,'9':21,
                   'A':1,'B':0,'C':5,'D':7,'E':9,'F':13,'G':15,'H':17,'I':19,'J':21,
                   'K':2,'L':4,'M':18,'N':20,'O':11,'P':3,'Q':6,'R':8,'S':12,'T':14,
                   'U':16,'V':10,'W':22,'X':25,'Y':24,'Z':23};
      const EVEN = {'0':0,'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,
                    'A':0,'B':1,'C':2,'D':3,'E':4,'F':5,'G':6,'H':7,'I':8,'J':9,
                    'K':10,'L':11,'M':12,'N':13,'O':14,'P':15,'Q':16,'R':17,'S':18,'T':19,
                    'U':20,'V':21,'W':22,'X':23,'Y':24,'Z':25};
      const CIN = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      function nameCode(s, isSurname){
        const S = slug(s);
        const c = CONS(S), v = VOWS(S);
        if (isSurname) return (c + v + 'XXX').slice(0,3);
        // nome: se ci sono >=4 consonanti prendi 1a, 3a, 4a
        if (c.length >= 4) return (c[0] + c[2] + c[3]);
        return (c + v + 'XXX').slice(0,3);
      }
      function dateCode(d, sex){
        const dt = new Date(d);
        if (isNaN(dt)) return 'YYMDD';
        const yy = String(dt.getFullYear()).slice(-2);
        const mm = MONTH[dt.getMonth()+1];
        let dd = dt.getDate();
        if (sex === 'F') dd += 40;
        return yy + mm + String(dd).padStart(2,'0');
      }
      function control(code15){
        let sum = 0;
        for (let i=0;i<15;i++){
          const ch = code15[i];
          sum += (i%2===0) ? ODD[ch] : EVEN[ch];
        }
        return CIN[sum % 26];
      }
      function build({ name, surname, birthDate, sex, belfiore }){
        if (!name || !surname || !birthDate || !sex || !belfiore) return '';
        const A = nameCode(surname, true);
        const B = nameCode(name, false);
        const C = dateCode(birthDate, sex);
        const D = (belfiore || '').toUpperCase();
        const base = A + B + C + D;
        return base + control(base);
      }
      return { build };
    })();

    (async function(){
      const wait = ms => new Promise(r => setTimeout(r, ms));
      // fallback CONFIG se mancasse
      setTimeout(()=>{
        if (typeof window.AUTH0_CONFIG === 'undefined') {
          const ORIGIN = location.origin;
          window.AUTH0_CONFIG = {
            domain: "dev-nmvv4fpc7jmiw1pw.eu.auth0.com",
            clientId: "Tpjl7J5RWMRm5WdGD8PCPTymMSFKiWmq",
            authorizationParams: { redirect_uri: ORIGIN },
            cacheLocation: "memory",
            useRefreshTokens: false
          };
        }
      },300);

      while (typeof auth0 === 'undefined' || typeof window.AUTH0_CONFIG === 'undefined') { await wait(30); }
      const client = await auth0.createAuth0Client(window.AUTH0_CONFIG);

      // callback cleanup
      if (location.search.includes('state=') && (location.search.includes('code=') || location.search.includes('error='))) {
        try { await client.handleRedirectCallback(); } catch(e) { console.warn(e); }
        history.replaceState({}, document.title, location.pathname);
      }

      const isAuth = await client.isAuthenticated();
      const $need = document.getElementById('need-auth');
      const $card = document.getElementById('profile');
      const $err  = document.getElementById('err');
      const $diag = document.getElementById('diag');

      if (!isAuth) {
        document.getElementById('cta-login')?.addEventListener('click', async (e)=>{
          e.preventDefault();
          try {
            await client.loginWithPopup();
            location.reload();
          } catch (e) {
            $err.textContent = e.message || String(e);
          }
        });
        return;
      }

      // token per Functions
      const token = await client.getTokenSilently({ authorizationParams: { audience: 'https://bebclean.it/api' } });

      // mostra card profilo
      $need.classList.add('hidden'); $card.classList.remove('hidden');

      // utente da Auth0
      const user = await client.getUser();
      const emailVerified = !!user?.email_verified;
      const email = user?.email || '';
      // prova a separare nome/cognome
      const firstName = user?.given_name || (user?.name||'').split(' ')[0] || '';
      const lastName  = user?.family_name || (user?.name||'').split(' ').slice(1).join(' ') || '';

      // riempi campi readonly
      document.getElementById('first_name').value = firstName;
      document.getElementById('last_name').value  = lastName;
      document.getElementById('email').value      = email;

      const emailStatus = document.getElementById('email_status');
      emailStatus.classList.add(emailVerified ? 'ok' : 'ko');
      emailStatus.querySelector('span:last-child').textContent = emailVerified ? 'Email verificata' : 'Email NON verificata';

      // carica profilo da Supabase (per telefono verificato)
      let prof = null;
      try {
        const r = await fetch('/.netlify/functions/profile-load', {
          headers: { 'authorization': 'Bearer ' + token }
        });
        prof = await r.json();
      } catch(e) {
        console.warn('profile-load error', e);
      }
      const phone = prof?.phone || '';
      const phoneVerified = !!prof?.phone_verified_at;

      document.getElementById('phone').value = phone || '(non impostato)';
      const phoneStatus = document.getElementById('phone_status');
      phoneStatus.classList.add(phoneVerified ? 'ok' : 'ko');
      phoneStatus.querySelector('span:last-child').textContent = phoneVerified ? 'Telefono verificato' : 'Telefono NON verificato';

      // carica comuni.json e popola datalist
      const comuni = await fetch('/assets/data/comuni.json').then(r=>r.json()).catch(()=>[]);
      const $list = document.getElementById('comuni-list');
      const map = new Map();
      for (const c of comuni) {
        const label = `${(c.nome||'').toUpperCase()} (${(c.provincia||'').toUpperCase()})`;
        const opt = document.createElement('option');
        opt.value = label;
        $list.appendChild(opt);
        map.set(label, (c.belfiore||'').toUpperCase());
      }

      // calcolo CF on-change
      const $sex = document.getElementById('sex');
      const $birth = document.getElementById('birth_date');
      const $comune = document.getElementById('comune');
      const $belfiore = document.getElementById('belfiore');
      const $cf = document.getElementById('codice_fiscale');

      function recalcCF(){
        const bf = map.get(($comune.value||'').toUpperCase());
        if (bf) $belfiore.value = bf;
        $cf.value = CF.build({
          name: firstName,
          surname: lastName,
          birthDate: $birth.value,
          sex: $sex.value,
          belfiore: $belfiore.value
        }) || '';
      }
      [$sex,$birth,$comune].forEach(el => el.addEventListener('change', recalcCF));
      $comune.addEventListener('input', recalcCF);

      // salva
      document.getElementById('save').addEventListener('click', async ()=>{
        document.getElementById('save_msg').textContent = '';
        document.getElementById('save_err').textContent = '';
        // validazione minima
        if (!$sex.value || !$birth.value || !$belfiore.value || !$cf.value) {
          document.getElementById('save_err').textContent = 'Compila Sesso, Data e seleziona un Comune valido.';
          return;
        }
        try {
          const res = await fetch('/.netlify/functions/profile-save', {
            method: 'POST',
            headers: { 'content-type':'application/json', 'authorization':'Bearer '+token },
            body: JSON.stringify({
              birth_date: $birth.value,
              birth_place_code: $belfiore.value,
              codice_fiscale: $cf.value
            })
          });
          const json = await res.json();
          if (!res.ok || !json?.saved) throw new Error(json?.error || 'Errore salvataggio');
          document.getElementById('save_msg').textContent = 'Salvato!';
        } catch(e) {
          document.getElementById('save_err').textContent = e.message || String(e);
        }
      });
    })();
  </script>
</body>
</html>
