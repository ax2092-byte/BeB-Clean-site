<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Accedi — B&B Clean</title>
  <meta name="description" content="Accedi o iscriviti per prenotare con B&B Clean.">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/bbclean-mark-32.png">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <!-- Auth0 SPA SDK (opzionale: se non configurato, parte il fallback) -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2/auth0-spa-js.production.js" defer></script>
</head>
<body class="light">
  <header class="container nav">
    <a class="brand" href="/index.html" aria-label="Home">
      <img src="/assets/img/bbclean-mark-64.png" alt="B&B Clean" class="logo">
      <span class="brand-text">B&B <strong>Clean</strong></span>
    </a>
    <nav>
      <a href="/servizi.html">Servizi</a>
      <a href="/login.html" class="active">Accedi</a>
      <a href="/signup.html" class="btn">Iscriviti</a>
    </nav>
  </header>

  <main class="container section">
    <h1>Accedi o crea un account</h1>
    <p class="subtitle">Per prenotare, accedi o registrati. Occorrono meno di 60 secondi.</p>

    <section id="auth-auto" class="card">
      <h2 class="section-title">Sto aprendo la pagina di accesso…</h2>
      <p class="muted">Se non succede nulla in qualche secondo, usa i pulsanti qui sotto.</p>
    </section>

    <section id="auth-fallback" class="card" style="display:none">
      <h2 class="section-title">Accesso rapido (fallback)</h2>
      <p class="muted">Auth0 non è ancora configurato. Puoi usare questo accesso di test per continuare il flusso.</p>
      <div class="cta">
        <button class="btn btn-primary" id="btn-demo">Accedi demo</button>
        <a class="btn btn-outline" id="btn-retry" href="#">Riprova accesso standard</a>
      </div>
      <p class="micro muted">Il fallback imposta solo una sessione locale per test e reindirizza alla pagina richiesta.</p>
    </section>
  </main>

  <footer class="footer">
    <div class="container footer-inner">
      <div class="footer-brand">
        <img src="/assets/img/bbclean-mark-64.png" alt="B&B Clean" class="logo">
        <div>B&B <strong>Clean</strong><br><span class="muted">Il tuo tempo è il nostro lavoro!</span></div>
      </div>
      <nav class="footer-links">
        <a href="/servizi.html">Servizi</a>
        <a href="/login.html?return=/prenota.html">Prenota</a>
        <a href="/partner.html">Diventa partner</a>
        <a href="/dashboard.html">Dashboard</a>
      </nav>
      <div class="footer-legal muted">© <span id="y"></span> B&B Clean — Tutti i diritti riservati</div>
    </div>
  </footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    // 1) Config — SOSTITUISCI con i tuoi valori quando pronti (Auth0 by Okta Netlify extension)
   const AUTH0_CFG = {
  domain: 'dev-nmvv4fpc7jmiw1pw.eu.auth0.com',
  clientId: 'Tpjl7J5RWMRm5WdGD8PCPTymMSFKiWmq',
  audience: '', // se non usi API, lascia vuoto
  redirectUri: window.location.origin + '/login.html'
  };
    // Utility
    function qs(name, def){ const v=new URLSearchParams(location.search).get(name); return v || def; }
    const RETURN_TO = qs('return', '/prenota.html');
    const MODE = (qs('mode','login') === 'signup') ? 'signup' : 'login';

    function showFallback(){
      document.getElementById('auth-auto').style.display='none';
      document.getElementById('auth-fallback').style.display='';
    }

    function persistAndGo(){
      try{
        localStorage.setItem('bbclean_auth','1');
        document.cookie = 'bb_auth=1; path=/; max-age='+(60*60*24*30);
      }catch(_){}
      location.replace(RETURN_TO);
    }

    // 2) Fallback handlers
    document.getElementById('btn-demo').addEventListener('click', persistAndGo);
    document.getElementById('btn-retry').addEventListener('click', (e)=>{
      e.preventDefault();
      location.reload();
    });

    // 3) Auth0 automatic flow (se configurato)
    window.addEventListener('load', async () => {
      // Se SDK non c'è o config placeholder → fallback
      if (typeof window.createAuth0Client !== 'function'
          || AUTH0_CFG.domain.startsWith('YOUR_')
          || AUTH0_CFG.clientId.startsWith('YOUR_')) {
        showFallback();
        return;
      }

      try{
        const auth0 = await createAuth0Client({
          domain: AUTH0_CFG.domain,
          clientId: AUTH0_CFG.clientId,
          authorizationParams: {
            redirect_uri: AUTH0_CFG.redirectUri,
            ...(AUTH0_CFG.audience ? { audience: AUTH0_CFG.audience } : {})
          }
        });

        // Se è un callback (code + state) completa il login e torna alla pagina richiesta
        if (location.search.includes('code=') && location.search.includes('state=')) {
          await auth0.handleRedirectCallback();
          const isAuth = await auth0.isAuthenticated();
          if (isAuth) { persistAndGo(); return; }
        }

        // Non è un callback → avvia login o signup
        localStorage.setItem('bb_return', RETURN_TO);
        await auth0.loginWithRedirect({
          authorizationParams: {
            redirect_uri: AUTH0_CFG.redirectUri,
            ...(AUTH0_CFG.audience ? { audience: AUTH0_CFG.audience } : {}),
            ...(MODE === 'signup' ? { screen_hint: 'signup' } : {})
          },
          appState: { returnTo: RETURN_TO }
        });
      }catch(err){
        // Se qualcosa va storto, mostra fallback
        showFallback();
      }
    });
  </script>
</body>
</html>
