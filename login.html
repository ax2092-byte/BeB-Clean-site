<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Accedi — B&B Clean</title>
  <meta name="description" content="Accedi o iscriviti per prenotare con B&B Clean.">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/bbclean-mark-32.png">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <!-- SDK Auth0 -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2/auth0-spa-js.production.js" defer></script>
</head>
<body class="light">
  <!-- Header -->
  <header class="container nav">
    <a class="brand" href="/index.html" aria-label="Home">
      <img src="/assets/img/bbclean-mark-64.png" alt="B&B Clean" class="logo">
      <span class="brand-text">B&B <strong>Clean</strong></span>
    </a>
    <nav>
      <a href="/servizi.html">Servizi</a>
      <a href="/login.html" class="active">Accedi</a>
      <a href="/login.html?mode=signup&return=/prenota.html" class="btn">Iscriviti</a>
    </nav>
  </header>

  <!-- Main -->
  <main class="container section">
    <h1>Accedi o crea un account</h1>
    <p class="subtitle">Per prenotare, accedi o registrati. Occorrono meno di 60 secondi.</p>

    <section id="auth-auto" class="card">
      <h2 class="section-title">Sto aprendo la pagina di accesso…</h2>
      <p class="muted">Se non succede nulla entro pochi secondi, aggiorna la pagina.</p>
    </section>

    <!-- Fallback visibile SOLO se l’SDK non carica o c’è un errore inatteso -->
    <section id="auth-fallback" class="card" style="display:none">
      <h2 class="section-title">Accesso non disponibile</h2>
      <p class="muted">Non riesco ad avviare l’accesso. Verifica connessione e riprova.</p>
      <div class="cta">
        <a class="btn btn-primary" href="/login.html">Riprova</a>
        <a class="btn btn-outline" href="/">Torna alla Home</a>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container footer-inner">
      <div class="footer-brand">
        <img src="/assets/img/bbclean-mark-64.png" alt="B&B Clean" class="logo">
        <div>B&B <strong>Clean</strong><br><span class="muted">Il tuo tempo è il nostro lavoro!</span></div>
      </div>
      <nav class="footer-links">
        <a href="/servizi.html">Servizi</a>
        <a href="/login.html?return=/prenota.html">Prenota</a>
        <a href="/partner.html">Diventa partner</a>
        <a href="/dashboard.html">Dashboard</a>
      </nav>
      <div class="footer-legal muted">© <span id="y"></span> B&B Clean — Tutti i diritti riservati</div>
    </div>
  </footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    // ===== CONFIG AUTH0 (TUO TENANT) =====
    const AUTH0_CFG = {
      domain:   'dev-nmvv4fpc7jmiw1pw.eu.auth0.com',
      clientId: 'Tpjl7J5RWMRm5WdGD8PCPTymMSFKiWmq',
      audience: '', // opzionale
      redirectUri: window.location.origin + '/login.html'
    };

    // ===== UTILS =====
    const qs = (k, d='') => new URLSearchParams(location.search).get(k) || d;
    const RETURN_TO = qs('return','/prenota.html');
    const MODE = (qs('mode','login') === 'signup') ? 'signup' : 'login';

    const $auto = document.getElementById('auth-auto');
    const $fb   = document.getElementById('auth-fallback');

    const showFallback = () => { $auto.style.display='none'; $fb.style.display=''; };

    // Controllo profilo lato funzione: se mancante → manda a /profilo.html prima di proseguire
    const profileCheck = async () => {
      try {
        const r = await fetch('/.netlify/functions/profile-load', { credentials: 'include' });
        if (!r.ok) return false;
        const data = await r.json();
        // atteso: { profile: {...}, complete: true/false } — consideriamo valido se esiste o completo
        return !!(data && (data.complete || data.profile));
      } catch { return false; }
    };

    const afterAuthRouting = async () => {
      const ok = await profileCheck();
      if (!ok) {
        location.replace('/profilo.html?return=' + encodeURIComponent(RETURN_TO));
      } else {
        location.replace(RETURN_TO);
      }
    };

    // ===== FLOW =====
    window.addEventListener('load', async () => {
      try {
        if (typeof window.createAuth0Client !== 'function') return showFallback();

        const client = await createAuth0Client({
          domain: AUTH0_CFG.domain,
          clientId: AUTH0_CFG.clientId,
          authorizationParams: {
            redirect_uri: AUTH0_CFG.redirectUri,
            ...(AUTH0_CFG.audience ? { audience: AUTH0_CFG.audience } : {})
          },
          cacheLocation: 'memory'
        });

        // Se torna da Auth0 (code+state), completa l'handshake
        if (location.search.includes('code=') && location.search.includes('state=')) {
          try { await client.handleRedirectCallback(); } catch {}
          // ripulisci la query ma conserva eventuale return
          const ret = qs('return');
          history.replaceState({}, document.title, location.pathname + (ret ? ('?return='+encodeURIComponent(ret)) : ''));
        }

        // Già autenticato → prosegui
        if (await client.isAuthenticated()) return afterAuthRouting();

        // Non autenticato → apri Universal Login (login o signup)
        await client.loginWithRedirect({
          authorizationParams: {
            redirect_uri: AUTH0_CFG.redirectUri,
            ...(AUTH0_CFG.audience ? { audience: AUTH0_CFG.audience } : {}),
            ...(MODE === 'signup' ? { screen_hint: 'signup' } : {})
          },
          appState: { returnTo: RETURN_TO }
        });
      } catch (e) {
        showFallback();
      }
    });
  </script>
</body>
</html>
