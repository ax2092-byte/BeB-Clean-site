<!-- FILE: /login.html  (AGGIORNATO: rispetta appState.returnTo per i partner; fallback clienti → /prenota.html) -->
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Accedi o registrati — B&B Clean</title>
  <meta name="description" content="Accedi o registrati per completare la prenotazione B&B Clean o accedere all’Area Partner.">
  <link rel="icon" href="/assets/img/favicon-32.png">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <style>
    :root{--brand:#0f9e9e;--brand-ink:#0a6f6f;--ink:#111827;--muted:#6b7280;--ring:#e5e7eb;--card:#f9fafb;--surface:#fff}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;color:var(--ink);background:var(--surface)}
    .container{width:min(900px,92%);margin:0 auto}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
    .topbar .left{display:flex;align-items:center;gap:10px}
    .back-arrow{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:999px;border:1px solid var(--ring);text-decoration:none;color:var(--ink)}
    .back-arrow:hover{background:#f3f4f6}
    .logo{height:32px;display:block}
    .mainnav a{text-decoration:none;color:var(--ink);font-weight:700;margin-left:16px;padding:8px 12px;border-radius:12px}
    .mainnav a:hover{background:#f3f4f6}
    .mainnav a.active{background:#e6f5f5;color:var(--brand-ink)}
    .hero{padding:36px 0 8px}
    .hero h1{font-size:clamp(26px,4vw,36px);margin:0 0 8px}
    .hero .sub{color:var(--muted);margin:0}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:18px}
    .btn{display:inline-block;border:1px solid var(--ring);padding:12px 16px;border-radius:14px;text-decoration:none;font-weight:700}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="topbar container" role="banner">
    <div class="left">
      <a id="back-link" class="back-arrow" href="#back" aria-label="Torna alla pagina precedente">←</a>
      <a href="/index.html" aria-label="B&B Clean — Home">
        <img class="logo" src="/assets/img/bbclean-logo-primary.png" alt="B&B Clean">
      </a>
    </div>
    <nav class="mainnav" aria-label="Menu principale">
      <a href="/index.html" data-page="home">HOME</a>
      <a href="/prenota.html" data-page="prenota">PRENOTA</a>
      <a href="/servizi.html" data-page="servizi">I NOSTRI SERVIZI</a>
      <a href="/partner.html" data-page="partner">DIVENTA PARTNER</a>
    </nav>
  </header>

  <!-- HERO -->
  <section class="hero container">
    <h1>Accedi o registrati</h1>
    <p class="sub">Per completare la prenotazione accedi (o crea un account). I partner usano l’Area Partner.</p>
  </section>

  <!-- BOX LOGIN -->
  <main class="container" style="margin-bottom:24px">
    <section class="card" id="gate">
      <div id="booking-summary" class="muted" style="margin-bottom:10px"></div>
      <div class="grid-2">
        <button id="btn-login" class="btn primary" type="button">Accedi</button>
        <button id="btn-signup" class="btn" type="button">Registrati</button>
      </div>
      <div id="login-note" class="muted" style="margin-top:10px">
        Dopo l’accesso verrai reindirizzato alla pagina di prenotazione.
      </div>
      <div class="muted" style="margin-top:6px">
        Sei un partner? Vai su <a href="/partner-login.html"><strong>Area Partner</strong></a>.
      </div>
    </section>
  </main>

  <footer class="container" style="border-top:1px solid var(--ring);padding:16px 0;color:var(--muted);font-size:14px">
    © 2025 B&B Clean — Il tuo tempo è il nostro lavoro!
  </footer>

  <!-- Script comune -->
  <script src="/assets/js/site.js" defer></script>

  <!-- Auth0 SPA SDK (locale) + Config + Helper -->
  <script src="/assets/js/vendor/auth0-spa-js.production.js"></script>
  <script src="/assets/js/auth-config.js"></script>
  <script src="/assets/js/auth.js"></script>

  <!-- Logica di Redirect/Login (CLIENTI) con supporto appState.returnTo -->
  <script>
  (async function(){
    const params = new URLSearchParams(location.search);
    const qs = params.toString();

    // salva la query della stima per riprenderla dopo il login cliente
    if (qs) sessionStorage.setItem('stima_qs', qs);

    // Riepilogo prenotazione (se presenti parametri)
    const regione = params.get('regione') || '';
    const citta = params.get('citta') || '';
    const indirizzo = params.get('indirizzo') || '';
    const civico = params.get('civico') || '';
    const mq = params.get('mq') || '';
    const summary = [];
    if (regione) summary.push(`Regione: <strong>${regione}</strong>`);
    if (citta) summary.push(`Città: <strong>${citta}</strong>`);
    if (indirizzo || civico) summary.push(`Indirizzo: <strong>${indirizzo}${civico?' '+civico:''}</strong>`);
    if (mq) summary.push(`Metri quadri: <strong>${mq}</strong>`);
    document.getElementById('booking-summary').innerHTML = summary.join(' • ');

    // Inizializza Auth0
    await window.Auth.ensureReady();

    // Gestione callback Auth0
    if (location.search.includes('code=') && location.search.includes('state=')) {
      await window.Auth.handleRedirect();

      // Se il login è partito da /partner-login.html, qui troviamo appState.returnTo
      const appState = window.Auth.getAppState && window.Auth.getAppState();
      if (appState && appState.returnTo) {
        const saved = sessionStorage.getItem('stima_qs') || '';
        const qsFinal = appState.qs || saved || '';
        location.replace(appState.returnTo + (qsFinal ? ('?' + qsFinal) : ''));
        return;
      }
    }

    // Se già autenticato → CLIENTE: vai a prenota mantenendo i parametri
    if (await window.Auth.isAuthenticated()) {
      const saved = sessionStorage.getItem('stima_qs') || '';
      location.replace("/prenota.html" + (saved ? ("?" + saved) : ""));
      return;
    }

    // Bottoni (CLIENTI): login/signup con appState verso /prenota.html
    const mkAppState = () => ({
      returnTo: "/prenota.html",
      qs: sessionStorage.getItem('stima_qs') || ''
    });

    document.getElementById('btn-login').addEventListener('click', async () => {
      await window.Auth.login({ screen_hint: null, appState: mkAppState() });
    });

    document.getElementById('btn-signup').addEventListener('click', async () => {
      await window.Auth.login({ screen_hint: 'signup', appState: mkAppState() });
    });

    // Freccia indietro
    const back = document.getElementById('back-link');
    if (back){
      back.addEventListener('click', function(e){
        e.preventDefault();
        if (history.length > 1) history.back();
        else location.href = '/index.html';
      });
    }
  })();
  </script>
</body>
</html>
