<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>B&B Clean — Accesso</title>
  <link rel="icon" href="/favicon.png">
  <meta name="description" content="Accedi o registrati a B&B Clean.">
  <style>
    :root { --border:#e5e7eb; --bg:#0b1220; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; }
    * { box-sizing: border-box; }
    body { margin:0; min-height:100vh; display:grid; place-items:center; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .card { max-width:460px; width:92%; padding:24px; border:1px solid var(--border); border-radius:14px; box-shadow:0 2px 12px rgba(0,0,0,.06); background:var(--card); text-align:center; }
    .btn { padding:10px 14px; border-radius:10px; border:1px solid var(--border); cursor:pointer; color:var(--text); text-decoration:none; display:inline-block; }
    .muted { color:var(--muted); font-size:14px; margin-top:8px; }
    .err { color:#fca5a5; margin-top:8px; white-space:pre-wrap; }
    .ok { color:#86efac; font-size:12px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Accesso in corso…</h1>
    <p class="muted">Se non parte automaticamente, clicca “Continua”.</p>
    <p><a id="loginBtn" class="btn" href="#">Continua</a></p>
    <div id="status" class="muted"></div>
    <div id="diag" class="ok"></div>
    <div id="error" class="err"></div>
  </div>

  <!-- 1) Provo a caricare la config esterna -->
  <script src="/assets/js/auth0-config.js" defer></script>

  <!-- 1b) Fallback CONFIG: se la config non arriva, la definisco io -->
  <script>
    (function ensureConfig(){
      var ORIGIN = window.location && window.location.origin;
      // se tra 300ms non esiste ancora, la creo io
      setTimeout(function(){
        if (typeof window.AUTH0_CONFIG === 'undefined') {
          window.AUTH0_CONFIG = {
            domain: "dev-nmvv4fpc7jmiw1pw.eu.auth0.com",
            clientId: "Tpjl7J5RWMRm5WdGD8PCPTymMSFKiWmq",
            authorizationParams: { redirect_uri: ORIGIN },
            cacheLocation: "memory",
            useRefreshTokens: false
          };
          window.AUTH0_LOGOUT_OPTIONS = { logoutParams: { returnTo: ORIGIN } };
        }
      }, 300);
    })();
  </script>

  <!-- 2) SDK Auth0 ufficiale (v2, percorso /2.0/) -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js" defer></script>

  <!-- 2b) Fallback SDK: se il CDN Auth0 fosse bloccato, carica da jsDelivr -->
  <script>
    if (typeof auth0 === 'undefined') {
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@auth0/auth0-spa-js@2.3.0/dist/auth0-spa-js.production.js';
      s.defer = true;
      document.head.appendChild(s);
    }
  </script>

  <!-- 3) Avvio login: legge role/mode dai parametri e chiama loginWithRedirect -->
  <script>
    (async function(){
      const wait = ms => new Promise(r => setTimeout(r, ms));

      // attendo che SDK e CONFIG siano disponibili
      while (typeof window.AUTH0_CONFIG === 'undefined' || typeof auth0 === 'undefined') {
        await wait(30);
      }

      // diagnostica minima
      const diag = document.getElementById('diag');
      if (diag) diag.textContent = 'SDK: ' + (typeof auth0) + ' · CONFIG: ' + (typeof window.AUTH0_CONFIG);

      const params = new URLSearchParams(window.location.search);
      const role = params.get('role') || 'client';   // "client" | "partner"
      const mode = params.get('mode') || 'login';    // "login" | "signup"

      const client = await auth0.createAuth0Client(window.AUTH0_CONFIG);

      const target = role === 'partner' ? '/dashboard.html' : '/prenota.html';
      const authorizationParams = {};
      if (mode === 'signup') authorizationParams.screen_hint = 'signup';

      const go = async () => {
        try {
          const st = document.getElementById('status');
          if (st) st.textContent = 'Reindirizzamento a Auth0…';
          await client.loginWithRedirect({
            authorizationParams,
            appState: { role, mode, target }
          });
        } catch (e) {
          const er = document.getElementById('error');
          if (er) er.textContent = e && e.message ? e.message : String(e);
        }
      };

      // bottone manuale
      document.getElementById('loginBtn').addEventListener('click', (e) => { e.preventDefault(); go(); });

      // avvio automatico
      go();
    })();
  </script>
</body>
</html>
