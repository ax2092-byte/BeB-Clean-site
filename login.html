<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Accedi — B&B Clean</title>
  <meta name="description" content="Accedi o iscriviti per prenotare con B&B Clean.">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/bbclean-mark-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/bbclean-logo-256.png">
  <meta property="og:image" content="/assets/img/bbclean-logo-256.png">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="stylesheet" href="/assets/css/styles.css">

  <!-- SDK Auth0 v2 (carico diretto, niente loader) -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2/auth0-spa-js.production.js" async crossorigin="anonymous"></script>
</head>
<body class="light">
  <!-- Header -->
  <header class="container nav">
    <a class="brand" href="/index.html" aria-label="Home">
      <img src="/assets/img/bbclean-mark-64.png" alt="B&B Clean" class="logo">
      <span class="brand-text">B&B <strong>Clean</strong></span>
    </a>
    <nav>
      <a href="/servizi.html">Servizi</a>
      <a href="/login.html" class="active">Accedi</a>
      <a href="/login.html?mode=signup&return=/prenota.html" class="btn">Iscriviti</a>
    </nav>
  </header>

  <!-- Main -->
  <main class="container section">
    <h1>Accedi o crea un account</h1>
    <p class="subtitle">Per prenotare, accedi o registrati. Occorrono meno di 60 secondi.</p>

    <section id="auth-auto" class="card">
      <h2 class="section-title">Sto aprendo la pagina di accesso…</h2>
      <p class="muted">Se non succede nulla entro pochi secondi, aggiorna la pagina.</p>
    </section>

    <section id="auth-fallback" class="card" style="display:none">
      <h2 class="section-title">Accesso non disponibile</h2>
      <p class="muted">Non riesco ad avviare l’accesso. Verifica connessione e riprova.</p>
      <div class="cta">
        <a class="btn btn-primary" href="/login.html">Riprova</a>
        <a class="btn btn-outline" href="/">Torna alla Home</a>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container footer-inner">
      <div class="footer-brand">
        <img src="/assets/img/bbclean-mark-64.png" alt="B&B Clean" class="logo">
        <div>B&B <strong>Clean</strong><br><span class="muted">Il tuo tempo è il nostro lavoro!</span></div>
      </div>
      <nav class="footer-links">
        <a href="/servizi.html">Servizi</a>
        <a href="/login.html?return=/prenota.html">Prenota</a>
        <a href="/partner.html">Diventa partner</a>
        <a href="/dashboard.html">Dashboard</a>
      </nav>
      <div class="footer-legal muted">© <span id="y"></span> B&B Clean — Tutti i diritti riservati</div>
    </div>
  </footer>

  <!-- App logic -->
  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    // Config fissa (tenant tuo)
    const AUTH0_CFG = {
      domain:   'dev-nmvv4fpc7jmiw1pw.eu.auth0.com',
      clientId: 'Tpjl7J5RWMRm5WdGD8PCPTymMSFKiWmq',
      audience: '',
      redirectUri: window.location.origin + '/login.html'
    };

    // Utils
    const qs = (k, d='') => new URLSearchParams(location.search).get(k) || d;
    const RETURN_TO = qs('return','/prenota.html');
    const MODE      = (qs('mode','login') === 'signup') ? 'signup' : 'login';

    const $auto = document.getElementById('auth-auto');
    const $fb   = document.getElementById('auth-fallback');
    const showFallback = () => { $auto.style.display='none'; $fb.style.display=''; };

    // Poll finché l’SDK è pronto, poi avvia il flow
    (function boot(){
      const ready = (typeof window.createAuth0Client === 'function');
      if (!ready) return setTimeout(boot, 40);

      (async () => {
        try {
          const client = await createAuth0Client({
            domain: AUTH0_CFG.domain,
            clientId: AUTH0_CFG.clientId,
            authorizationParams: {
              redirect_uri: AUTH0_CFG.redirectUri,
              ...(AUTH0_CFG.audience ? { audience: AUTH0_CFG.audience } : {})
            },
            cacheLocation: 'memory'
          });

          // Callback dopo Auth0
          if (location.search.includes('code=') && location.search.includes('state=')) {
            try { await client.handleRedirectCallback(); } catch {}
            const ret = qs('return');
            history.replaceState({}, document.title, location.pathname + (ret ? ('?return='+encodeURIComponent(ret)) : ''));
          }

          // Già autenticato → routing
          if (await client.isAuthenticated()) {
            // Check profilo: se assente/bozza → prima profilo
            try {
              const r = await fetch('/.netlify/functions/profile-load', { credentials: 'include' });
              if (!r.ok) { location.replace('/profilo.html?return=' + encodeURIComponent(RETURN_TO)); return; }
              const data = await r.json();
              const ok = !!(data && (data.complete || data.profile));
              location.replace(ok ? RETURN_TO : ('/profilo.html?return=' + encodeURIComponent(RETURN_TO)));
              return;
            } catch {
              location.replace('/profilo.html?return=' + encodeURIComponent(RETURN_TO));
              return;
            }
          }

          // Non autenticato → Universal Login
          await client.loginWithRedirect({
            authorizationParams: {
              redirect_uri: AUTH0_CFG.redirectUri,
              ...(AUTH0_CFG.audience ? { audience: AUTH0_CFG.audience } : {}),
              ...(MODE === 'signup' ? { screen_hint: 'signup' } : {})
            },
            appState: { returnTo: RETURN_TO }
          });
        } catch(e) {
          showFallback();
        }
      })();
    })();
  </script>
</body>
</html>
