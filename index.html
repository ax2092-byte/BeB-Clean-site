<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin — B&B Clean</title>
    <link rel="icon" type="image/png" href="../favicon.png">
    <style>
      /* Campo "Codice casa" in sola lettura (visibile) */
      .bb-readonly { background:#f6f7f9; color:#555; pointer-events:none; }

      /* Autocomplete custom */
      .bb-ac-panel {
        position: absolute; z-index: 99999; min-width: 240px; max-width: 520px;
        max-height: 240px; overflow: auto; background: #fff; border: 1px solid #ddd;
        border-radius: .5rem; box-shadow: 0 10px 22px rgba(0,0,0,.08);
        font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }
      .bb-ac-item { padding: .5rem .75rem; cursor: pointer; }
      .bb-ac-item:hover, .bb-ac-item.active { background: #f2f4f7; }
      .bb-ac-empty { padding: .5rem .75rem; color: #666; }
      .bb-ac-spinner { padding: .5rem .75rem; color: #666; font-style: italic; }

      /* Bottone copia */
      .bb-inline { display:inline-flex; gap:.5rem; align-items:center; width:100%; }
      .bb-copy { padding:.35rem .6rem; border:1px solid #ccc; border-radius:.4rem; background:#fff; cursor:pointer; }
    </style>
  </head>
  <body>
    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!-- Netlify Identity (login/signup) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        if (!window.netlifyIdentity) return;
        window.netlifyIdentity.init();
        var hash = window.location.hash || '';
        if (hash.includes('invite_token') || hash.includes('confirmation_token')) {
          window.netlifyIdentity.open('signup');
        }
        window.netlifyIdentity.on('login',  () => window.location.reload());
        window.netlifyIdentity.on('signup', () => window.location.reload());
      });
    </script>
    <button id="idBtn" style="position:fixed;right:16px;bottom:16px;padding:.6rem 1rem;border:1px solid #ddd;border-radius:.4rem;background:#fff;cursor:pointer;z-index:9999;">
      Accedi / Registrati
    </button>
    <script>document.getElementById('idBtn').onclick=()=>window.netlifyIdentity&&window.netlifyIdentity.open();</script>

    <!-- Script principale -->
    <script>
      (function () {
        // ================== UTILITÀ ==================
        const PREFIX = 'BB';
        const MONTH = { A:1,B:2,C:3,D:4,E:5,H:6,L:7,M:8,P:9,R:10,S:11,T:12 };
        const ODD = { '0':1,'1':0,'2':5,'3':7,'4':9,'5':13,'6':15,'7':17,'8':19,'9':21,
          A:1,B:0,C:5,D:7,E:9,F:13,G:15,H:17,I:19,J:21,K:2,L:4,M:18,N:20,O:11,P:3,Q:6,R:8,S:12,T:14,U:16,V:10,W:22,X:25,Y:24,Z:23 };
        const EVEN = { '0':0,'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,
          A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25 };

        function norm(s){return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Za-z0-9]/g,'').toUpperCase();}
        function fnv1a(str){let h=0x811c9dc5>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=(h+(h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24))>>>0;}return h>>>0;}
        function parseDMY(dmy){if(!/^\d{2}\/\d{2}\/\d{4}$/.test(dmy||''))return null;const d=+dmy.slice(0,2),m=+dmy.slice(3,5),y=+dmy.slice(6,10);if(m<1||m>12||d<1||d>31)return null;return {d,m,y};}
        function cfChecksum(cf15){let s=0;for(let i=0;i<15;i++){const c=cf15[i];if(!c)return null;s+=((i%2)===0?ODD[c]:EVEN[c]);}return String.fromCharCode((s%26)+65);}
        function validateCF(cf,dmy,gender){
          const out={valid:false,message:""};
          if(!cf||!/^[A-Z0-9]{16}$/i.test(cf)){out.message="Formato CF non valido (16 caratteri).";return out;}
          cf=cf.toUpperCase();
          const expected=cfChecksum(cf.slice(0,15)); if(!expected||expected!==cf[15]){out.message="Carattere di controllo CF non valido.";return out;}
          const p=parseDMY(dmy); if(!p||!gender){out.message="Inserisci data (dd/mm/yyyy) e sesso.";return out;}
          const yy=String(p.y).slice(2,4), cfYY=cf.slice(6,8), cfM=cf[8], cfDD=+cf.slice(9,11);
          if(cfYY!==yy){out.message="CF non coincide con anno.";return out;}
          if(MONTH[cfM]!==p.m){out.message="CF non coincide con mese.";return out;}
          const dd=(gender==='F')?(p.d+40):p.d; if(cfDD!==dd){out.message="CF non coincide con giorno/sesso.";return out;}
          out.valid=true; return out;
        }
        function buildHouseCode(p){
          const nZip=norm(p.zip).slice(0,5).padEnd(5,'0');
          const nCity=norm(p.city).slice(0,3).padEnd(3,'X');
          const base=[norm(p.region),norm(p.zip),norm(p.city),norm(p.street),norm(p.number),norm(p.owner_cf)].join('|');
          const hash5=fnv1a(base).toString(36).toUpperCase().slice(0,5).padStart(5,'0');
          return `${PREFIX}-${nZip}-${nCity}-${hash5}`;
        }

        function findFieldByLabel(txt){
          const labs=[...document.querySelectorAll('label')];
          const lab=labs.find(l=>l.textContent && l.textContent.trim().toLowerCase().includes(txt.toLowerCase()));
          if(!lab) return null;
          const wrap=lab.closest('[class*="ControlContainer"]')||lab.parentElement;
          return wrap ? wrap.querySelector('input,select') : null;
        }
        function setReactValue(el, value){
          if (!el) return;
          if (el.__bbSetting) return;
          const setter = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value').set;
          el.__bbSetting = true;
          setter.call(el, value);
          el.dispatchEvent(new Event('input', { bubbles: true }));
          setTimeout(()=>{ el.__bbSetting = false; }, 0);
        }
        function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

        // ================== AUTOCOMPLETE CUSTOM ==================
        const FALLBACK_CITIES = {
          "Sardegna": ["Cagliari","Carbonia","Dorgali","Nuoro","Olbia","Oristano","Orosei","Sassari"],
          "Lazio": ["Roma","Fiumicino","Tivoli","Viterbo","Latina","Rieti"],
          "Lombardia": ["Milano","Bergamo","Brescia","Como","Lecco","Monza","Pavia","Varese"],
          "Piemonte": ["Torino","Alessandria","Asti","Cuneo","Novara","Vercelli"],
          "Campania": ["Napoli","Salerno","Caserta","Avellino","Benevento"],
          "Sicilia": ["Palermo","Catania","Messina","Siracusa","Ragusa","Trapani"],
          "Toscana": ["Firenze","Pisa","Lucca","Prato","Siena","Arezzo"]
        };

        function createPanel(){
          const p=document.createElement('div'); p.className='bb-ac-panel'; p.style.display='none'; document.body.appendChild(p); return p;
        }
        const cityPanel = createPanel();
        const streetPanel = createPanel();

        function positionPanel(panel, input){
          const r=input.getBoundingClientRect();
          panel.style.left = (window.scrollX + r.left) + 'px';
          panel.style.top  = (window.scrollY + r.bottom + 4) + 'px';
          panel.style.minWidth = r.width + 'px';
          panel.style.display='block';
        }
        function fillPanel(panel, items, onPick){
          panel.innerHTML='';
          if (!items || items.length===0){ const d=document.createElement('div'); d.className='bb-ac-empty'; d.textContent='Nessun risultato'; panel.appendChild(d); return; }
          items.forEach((txt,i)=>{
            const it=document.createElement('div'); it.className='bb-ac-item'; it.textContent=txt;
            it.onmousedown=(e)=>{ e.preventDefault(); onPick(txt); panel.style.display='none'; };
            panel.appendChild(it);
          });
        }
        function showSpinner(panel){ panel.innerHTML='<div class="bb-ac-spinner">Sto cercando…</div>'; }
        document.addEventListener('click', (e)=>{
          if (!cityPanel.contains(e.target)) cityPanel.style.display='none';
          if (!streetPanel.contains(e.target)) streetPanel.style.display='none';
        });

        async function suggestCities(q, region){
          // Prova OSM
          if (q && q.length>=1){
            try{
              const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&accept-language=it&countrycodes=it&limit=12&q=${encodeURIComponent(q)}`;
              const r=await fetch(url); const js=await r.json();
              const allowed=new Set(['city','town','village','hamlet','municipality']); const out=[];
              for(const it of js){
                const city=it.address.city||it.address.town||it.address.village||it.address.hamlet||it.address.municipality;
                const reg =it.address.state||it.address.region;
                if (allowed.has(it.type) && city){
                  // filtro soft per regione (se diversa, non escludo ma do priorità)
                  out.push({city, score: (region && reg && reg.toLowerCase().includes(region.toLowerCase())) ? 0 : 1});
                }
              }
              out.sort((a,b)=>a.score-b.score);
              const names=[...new Set(out.map(o=>o.city))];
              if (names.length) return names;
            }catch(e){}
          }
          // Fallback locale per regione
          const loc = FALLBACK_CITIES[region] || [];
          const filtered = q ? loc.filter(x=>x.toLowerCase().includes(q.toLowerCase())) : loc;
          return filtered.slice(0,12);
        }

        async function suggestStreets(q, city){
          if (!city) return [];
          if (q && q.length>=1){
            try{
              const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&accept-language=it&countrycodes=it&limit=12&q=${encodeURIComponent(q+', '+city+', Italia')}`;
              const r=await fetch(url); const js=await r.json();
              const out=[];
              for(const it of js){
                const road=it.address.road||it.address.pedestrian||it.address.footway||it.address.path||it.address.cycleway||'';
                if (road) out.push(road);
              }
              const uniq=[...new Set(out)];
              if (uniq.length) return uniq;
            }catch(e){}
          }
          // Fallback: riprende vie già salvate per quella città
          try{
            const r=await fetch('/houses.json', {cache:'no-store'}); const data=await r.json();
            const arr=(data.items||[]).filter(x=>x.city===city).map(x=>x.street).filter(Boolean);
            const uniq=[...new Set(arr)];
            return (q ? uniq.filter(x=>x.toLowerCase().includes(q.toLowerCase())) : uniq).slice(0,12);
          }catch(e){ return []; }
        }

        function attachAutocomplete(input, panel, fetcher, onPick){
          if (!input) return;
          const run = debounce(async ()=>{
            const q=input.value.trim();
            panel.style.display='block';
            positionPanel(panel, input);
            showSpinner(panel);
            const items = await fetcher(q);
            fillPanel(panel, items, (val)=>{ onPick(val); });
          }, 250);
          input.addEventListener('input', ()=>{ positionPanel(panel, input); run(); });
          input.addEventListener('focus', ()=>{ positionPanel(panel, input); run(); });
          input.addEventListener('keydown', (e)=>{ if (e.key==='Escape'){ panel.style.display='none'; }});
        }

        // ================== DATA MASK ==================
        function attachBirthMask(){
          const el = findFieldByLabel('Data di nascita');
          if (!el) return;
          el.placeholder='gg/mm/aaaa';
          const mask = (v)=>{
            v = (v||'').replace(/[^\d]/g,'').slice(0,8);
            if (v.length>=5) return v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4);
            if (v.length>=3) return v.slice(0,2)+'/'+v.slice(2);
            return v;
          };
          const onInput = ()=> {
            if (el.__bbSetting) return;
            const m = mask(el.value);
            if (el.value !== m) setReactValue(el, m);
          };
          const onBlur = ()=> {
            if (el.__bbSetting) return;
            const m = mask(el.value);
            if (el.value !== m) setReactValue(el, m);
          };
          const onPaste = (e)=> {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text') || '';
            setReactValue(el, text);
          };
          el.addEventListener('input', onInput);
          el.addEventListener('blur', onBlur);
          el.addEventListener('paste', onPaste);
        }

        // ================== BLOCCO CAMPO CODICE CASA ==================
        function lockCodeField(){
          const el = findFieldByLabel('Codice casa');
          if (!el || el.dataset.bbLocked==='1') return;
          el.dataset.bbLocked='1';
          el.readOnly = true;
          el.setAttribute('aria-readonly','true');
          el.classList.add('bb-readonly');
          el.addEventListener('keydown', (e)=>{
            const ok=['Tab','Shift','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Home','End'];
            if(!e.ctrlKey && !e.metaKey && !ok.includes(e.key)) e.preventDefault();
          });
          el.addEventListener('beforeinput', (e)=> e.preventDefault());
          el.addEventListener('paste', (e)=> e.preventDefault());
          // bottone copia
          const parent = el.parentElement;
          if (parent && !parent.querySelector('.bb-copy')){
            const wrap = document.createElement('div'); wrap.className='bb-inline';
            parent.insertBefore(wrap, el);
            wrap.appendChild(el);
            const btn=document.createElement('button'); btn.type='button'; btn.className='bb-copy'; btn.textContent='Copia';
            btn.onclick=()=>{ el.select(); document.execCommand('copy'); btn.textContent='Copiato!'; setTimeout(()=>btn.textContent='Copia',1200); };
            wrap.appendChild(btn);
          }
        }

        // ================== GENERAZIONE LIVE CODICE ==================
        function updateHouseCode(){
          const region  = findFieldByLabel('Regione')?.value || '';
          const city    = findFieldByLabel('Città')?.value || '';
          const zip     = findFieldByLabel('CAP')?.value || '';
          const street  = findFieldByLabel('Via')?.value || '';
          const number  = findFieldByLabel('Civico')?.value || '';
          const cf      = (findFieldByLabel('Codice fiscale')?.value || '').toUpperCase();
          const birth   = findFieldByLabel('Data di nascita')?.value || '';
          const gender  = findFieldByLabel('Sesso')?.value || '';

          const codeEl  = findFieldByLabel('Codice casa');
          if (!codeEl) return;

          const ready = region && city && zip && street && number && cf && birth && gender;
          if (!ready){ setReactValue(codeEl,''); return; }

          const cfCheck = validateCF(cf, birth, gender);
          if (!cfCheck.valid){ setReactValue(codeEl,''); return; }

          const code = buildHouseCode({ region, city, zip, street, number, owner_cf: cf });
          if (codeEl.value !== code) setReactValue(codeEl, code);
        }

        // ================== WIRING ==================
        async function setup(){
          attachBirthMask();
          lockCodeField();

          const regionSel = findFieldByLabel('Regione');   // select
          const cityInput = findFieldByLabel('Città');
          const streetInp = findFieldByLabel('Via');
          const numInput  = findFieldByLabel('Civico');

          // Autocomplete City
          attachAutocomplete(
            cityInput,
            cityPanel,
            async (q)=>{
              const region = regionSel ? regionSel.value : '';
              return await suggestCities(q, region);
            },
            (val)=>{ setReactValue(cityInput, val); updateHouseCode(); }
          );

          // Autocomplete Street
          attachAutocomplete(
            streetInp,
            streetPanel,
            async (q)=>{
              const city = cityInput ? cityInput.value : '';
              return await suggestStreets(q, city);
            },
            (val)=>{ setReactValue(streetInp, val); updateHouseCode(); }
          );

          // Eventi che rigenerano il codice
          [regionSel, cityInput, streetInp, numInput,
           findFieldByLabel('CAP'),
           findFieldByLabel('Codice fiscale'),
           findFieldByLabel('Sesso'),
           findFieldByLabel('Data di nascita')
          ].filter(Boolean).forEach(el=>{
            const evt = (el.tagName==='SELECT') ? 'change' : 'input';
            el.addEventListener(evt, updateHouseCode);
          });

          // Primo calcolo
          updateHouseCode();
        }

        CMS.registerEventListener({ name:'preSave', handler:()=>{ updateHouseCode(); } });
        CMS.registerEventListener({
          name:'prePublish',
          handler:({entry,collection})=>{
            if (!collection || collection.get('name')!=='houses') return;
            const items = entry.get('data')?.get?.('items') || [];
            for (let i=0;i<items.size;i++){
              const it=items.get(i);
              const code=String(it.get('code')||'');
              if (!code){ alert("Codice casa mancante alla riga "+(i+1)+". Completa i dati e il CF."); throw new Error("code mancante"); }
              if (!code.startsWith(PREFIX+'-')){ alert("Codice casa non valido alla riga "+(i+1)); throw new Error("code invalido"); }
            }
          }
        });

        // Osserva il DOM dell'admin (Decap monta i form in asincrono)
        const obs = new MutationObserver(()=>{ requestAnimationFrame(()=>{ setup(); }); });
        obs.observe(document.body, { childList:true, subtree:true });

        document.addEventListener('DOMContentLoaded', ()=>{ setup(); });
      })();
    </script>
  </body>
</html>
