<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin — B&B Clean</title>
    <link rel="icon" type="image/png" href="../favicon.png">
    <style>
      /* stile per campo "Codice casa" in sola lettura */
      .bb-readonly { background:#f6f7f9; color:#555; pointer-events:none; }
      .bb-inline { display:inline-flex; gap:.5rem; align-items:center; width:100%; }
      .bb-copy { padding:.35rem .6rem; border:1px solid #ccc; border-radius:.4rem; background:#fff; cursor:pointer; }
    </style>
  </head>
  <body>
    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!-- Netlify Identity -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        if (!window.netlifyIdentity) return;
        window.netlifyIdentity.init();
        var hash = window.location.hash || '';
        if (hash.includes('invite_token') || hash.includes('confirmation_token')) {
          window.netlifyIdentity.open('signup');
        }
        window.netlifyIdentity.on('login',  () => window.location.reload());
        window.netlifyIdentity.on('signup', () => window.location.reload());
      });
    </script>
    <button id="idBtn" style="position:fixed;right:16px;bottom:16px;padding:.6rem 1rem;border:1px solid #ddd;border-radius:.6rem;background:#fff;cursor:pointer;z-index:9999;">
      Accedi / Registrati
    </button>
    <script>document.getElementById('idBtn').onclick=()=>window.netlifyIdentity&&window.netlifyIdentity.open();</script>

    <script>
      (function () {
        // ---------- Utilità ----------
        const PREFIX = 'BB';
        const MONTH = { A:1,B:2,C:3,D:4,E:5,H:6,L:7,M:8,P:9,R:10,S:11,T:12 };
        const ODD = { '0':1,'1':0,'2':5,'3':7,'4':9,'5':13,'6':15,'7':17,'8':19,'9':21,
          A:1,B:0,C:5,D:7,E:9,F:13,G:15,H:17,I:19,J:21,K:2,L:4,M:18,N:20,O:11,P:3,Q:6,R:8,S:12,T:14,U:16,V:10,W:22,X:25,Y:24,Z:23 };
        const EVEN = { '0':0,'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,
          A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25 };

        function norm(s){return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Za-z0-9]/g,'').toUpperCase();}
        function fnv1a(str){let h=0x811c9dc5>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=(h+(h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24))>>>0;}return h>>>0;}
        function parseDMY(dmy){if(!/^\d{2}\/\d{2}\/\d{4}$/.test(dmy||''))return null;const d=+dmy.slice(0,2),m=+dmy.slice(3,5),y=+dmy.slice(6,10);if(m<1||m>12||d<1||d>31)return null;return {d,m,y};}
        function cfChecksum(cf15){let s=0;for(let i=0;i<15;i++){const c=cf15[i];if(!c)return null;s+=((i%2)===0?ODD[c]:EVEN[c]);}return String.fromCharCode((s%26)+65);}
        function validateCF(cf,dmy,gender){const out={valid:false,message:""};if(!cf||!/^[A-Z0-9]{16}$/i.test(cf)){out.message="Formato CF non valido (16 caratteri).";return out;}
          cf=cf.toUpperCase();const expected=cfChecksum(cf.slice(0,15));if(!expected||expected!==cf[15]){out.message="Carattere di controllo CF non valido.";return out;}
          const p=parseDMY(dmy);if(!p||!gender){out.message="Inserisci data di nascita (dd/mm/yyyy) e sesso.";return out;}
          const yy=String(p.y).slice(2,4), cfYY=cf.slice(6,8), cfM=cf[8], cfDD=+cf.slice(9,11);
          if(cfYY!==yy){out.message="CF non coincide con anno di nascita.";return out;}
          if(MONTH[cfM]!==p.m){out.message="CF non coincide con mese di nascita.";return out;}
          const dd=(gender==='F')?(p.d+40):p.d; if(cfDD!==dd){out.message="CF non coincide con giorno/sesso.";return out;}
          out.valid=true;return out;}

        function buildHouseCode(p){
          const nZip=norm(p.zip).slice(0,5).padEnd(5,'0');
          const nCity=norm(p.city).slice(0,3).padEnd(3,'X');
          const base=[norm(p.region),norm(p.zip),norm(p.city),norm(p.street),norm(p.number),norm(p.owner_cf)].join('|');
          const hash5=fnv1a(base).toString(36).toUpperCase().slice(0,5).padStart(5,'0');
          return `${PREFIX}-${nZip}-${nCity}-${hash5}`;
        }

        // Maschera data: dd/mm/yyyy con slash automatici
        function attachDateMask(input){if(!input)return;input.placeholder='gg/mm/aaaa';
          input.addEventListener('input',()=>{let v=input.value.replace(/[^\d]/g,'').slice(0,8);if(v.length>=5)v=v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4);else if(v.length>=3)v=v.slice(0,2)+'/'+v.slice(2);input.value=v;});}

        // Trova input/select dal label (approccio robusto con observer)
        function findFieldByLabelStarts(text){
          const labels=[...document.querySelectorAll('label')];
          const label=labels.find(l=>l.textContent.trim().startsWith(text));
          if(!label)return null;
          const wrap=label.closest('[class*="ControlContainer"]')||label.parentElement;
          return wrap? (wrap.querySelector('input,select')||null):null;
        }

        // Datalist helpers
        function attachDatalist(input,id){if(!input)return null;let dl=document.getElementById(id);if(!dl){dl=document.createElement('datalist');dl.id=id;document.body.appendChild(dl);}input.setAttribute('list',id);return dl;}
        function setOptions(dl,arr){if(!dl)return;dl.innerHTML='';(arr||[]).forEach(v=>{const o=document.createElement('option');o.value=v;dl.appendChild(o);});}
        function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}

        // OSM (Nominatim) autocomplete
        async function osmCitySuggest(q,region){if(!q||q.length<2)return[];const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&accept-language=it&countrycodes=it&limit=8&q=${encodeURIComponent(q)}`;
          const r=await fetch(url);const js=await r.json();const allowed=new Set(['city','town','village','hamlet','municipality']);const out=[];
          for(const it of js){const city=it.address.city||it.address.town||it.address.village||it.address.hamlet||it.address.municipality;const reg=it.address.state||it.address.region;const typeOk=allowed.has(it.type);
            if(typeOk&&city){if(region&&reg&&reg.toLowerCase().indexOf(region.toLowerCase())===-1)continue;out.push(city);}}
          return [...new Set(out)].slice(0,8);}
        async function osmStreetSuggest(q,city){if(!q||q.length<2||!city)return[];const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&accept-language=it&countrycodes=it&limit=8&q=${encodeURIComponent(q+', '+city+', Italia')}`;
          const r=await fetch(url);const js=await r.json();const out=[];for(const it of js){const road=it.address.road||it.address.pedestrian||it.address.footway||it.address.path||it.address.cycleway||'';if(road)out.push(road);}return [...new Set(out)].slice(0,8);}

        async function loadExisting(){try{const r=await fetch('/houses.json',{cache:'no-store'});return await r.json();}catch(e){return{items:[]};}}

        async function setupUI(){
          // Maschera data
          attachDateMask(findFieldByLabelStarts('Proprietario - Data di nascita'));

          // Codice casa: read-only + pulsante copia
          const codeField=findFieldByLabelStarts('Codice casa');
          if(codeField){
            codeField.readOnly=true; codeField.classList.add('bb-readonly');
            // wrap con bottone copia
            const wrapper=document.createElement('div');wrapper.className='bb-inline';
            codeField.parentNode.insertBefore(wrapper, codeField);
            wrapper.appendChild(codeField);
            const copyBtn=document.createElement('button');copyBtn.type='button';copyBtn.className='bb-copy';copyBtn.textContent='Copia';
            copyBtn.onclick=()=>{codeField.select();document.execCommand('copy');copyBtn.textContent='Copiato!';setTimeout(()=>copyBtn.textContent='Copia',1200);};
            wrapper.appendChild(copyBtn);
          }

          // Autocomplete città/vie/civico
          const regionSel = findFieldByLabelStarts('Regione');   // è un <select>
          const cityInput = findFieldByLabelStarts('Città');
          const streetInp = findFieldByLabelStarts('Via');
          const numInput  = findFieldByLabelStarts('Civico');

          const dlCities  = attachDatalist(cityInput, 'dl-cities');
          const dlStreets = attachDatalist(streetInp, 'dl-streets');
          const dlNums    = attachDatalist(numInput,  'dl-nums');

          const existing=await loadExisting();
          const items=Array.isArray(existing.items)?existing.items:[];

          function refreshNumbers(){
            const city=(cityInput?.value||'').trim();
            const nums=[...new Set(items.filter(x=>(x.city||'')===city).map(x=>(x.number||'').trim()).filter(Boolean))].sort();
            setOptions(dlNums, nums);
          }

          const suggestCities = debounce(async ()=>{
            const q=(cityInput?.value||'').trim(); const region=regionSel?regionSel.value:'';
            const osm=await osmCitySuggest(q,region);
            const fromData=[...new Set(items.filter(x=>!q||x.city.toLowerCase().includes(q.toLowerCase())).map(x=>x.city))];
            const merged=[...new Set([...(osm||[]),...(fromData||[])])].slice(0,20);
            setOptions(dlCities, merged); refreshNumbers();
          }, 450);

          const suggestStreets = debounce(async ()=>{
            const q=(streetInp?.value||'').trim(); const city=(cityInput?.value||'').trim();
            const osm=await osmStreetSuggest(q,city);
            const fromData=[...new Set(items.filter(x=>(!q||(x.street||'').toLowerCase().includes(q.toLowerCase()))&&(!city||x.city===city)).map(x=>x.street).filter(Boolean))];
            const merged=[...new Set([...(osm||[]),...(fromData||[])])].slice(0,20);
            setOptions(dlStreets, merged); refreshNumbers();
          }, 450);

          regionSel && regionSel.addEventListener('change', ()=>{suggestCities(); suggestStreets();});
          cityInput && cityInput.addEventListener('input', ()=>{suggestCities(); suggestStreets();});
          streetInp && streetInp.addEventListener('input', suggestStreets);
          numInput && numInput.addEventListener('focus', refreshNumbers);

          // Primo popolamento
          suggestCities(); suggestStreets(); refreshNumbers();
        }

        // Genera codice e blocca duplicati CF+indirizzo
        CMS.registerEventListener({
          name:'preSave',
          handler:({entry,collection})=>{
            if(!collection||collection.get('name')!=='houses')return;
            let data=entry.get('data'); let items=data&&data.get&&data.get('items'); if(!items||!items.forEach)return;

            // set codici già presenti
            const existingCodes=new Set(); items.forEach(it=>{const c=it?.get?.('code'); if(c)existingCodes.add(String(c).toUpperCase());});

            items = items.map(it=>{
              // se già presente, non toccare
              if(it.get('code')) return it;

              const payload={
                region: it.get('region'),
                city:   it.get('city'),
                province: it.get('province'),
                zip:    it.get('zip'),
                street: it.get('street'),
                number: it.get('number'),
                owner_cf: norm(it.get('owner_cf')),
                owner_birth: it.get('owner_birth'),
                owner_gender: it.get('owner_gender')
              };

              const mandatory=['region','city','province','zip','street','number','owner_cf','owner_birth','owner_gender'];
              for(const k of mandatory){ if(!payload[k]) return it; }

              const cfCheck=validateCF(payload.owner_cf, String(payload.owner_birth), payload.owner_gender);
              if(!cfCheck.valid){ alert("Errore Codice Fiscale: "+cfCheck.message); return it; }

              let code=buildHouseCode(payload);
              if(existingCodes.has(code)){ let i=2; while(existingCodes.has(`${code}-${i}`)&&i<99)i++; code=`${code}-${i}`; }
              existingCodes.add(code);
              return it.set('code', code);
            });

            data=data.set('items',items);
            return { entry: entry.set('data', data) };
          }
        });

        CMS.registerEventListener({
          name:'prePublish',
          handler:({entry,collection})=>{
            if(!collection||collection.get('name')!=='houses')return;
            const items=entry.get('data')?.get?.('items')||[];

            // 1) tutti devono avere code
            for(let i=0;i<items.size;i++){ const it=items.get(i); if(!it?.get?.('code')){ alert("Impossibile pubblicare: completa i dati e un CF valido (voce n° "+(i+1)+")."); throw new Error("code mancante"); } }

            // 2) blocca duplicati: stesso owner_cf + stesso indirizzo (via+civico+CAP+città+regione)
            const seen=new Map();
            function addrKey(it){return [norm(it.get('owner_cf')),norm(it.get('street')),norm(it.get('number')),norm(it.get('zip')),norm(it.get('city')),norm(it.get('region'))].join('|');}
            for(let i=0;i<items.size;i++){
              const it=items.get(i); const key=addrKey(it);
              if(seen.has(key)){ const j=seen.get(key); alert(`Duplicato trovato: stessa casa per lo stesso CF (righe ${j+1} e ${i+1}). Correggi o rimuovi una delle due.`); throw new Error("duplicato CF+indirizzo"); }
              seen.set(key,i);
            }
          }
        });

        // Avvio UI con observer (Decap monta i form in asincrono)
        const obs=new MutationObserver(()=>{const code=findFieldByLabelStarts('Codice casa'); if(code){ obs.disconnect(); setupUI(); }});
        obs.observe(document.body,{childList:true,subtree:true});
      })();
    </script>
  </body>
</html>
