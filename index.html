<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin — B&B Clean</title>
    <link rel="icon" type="image/png" href="../favicon.png">
    <style>
      /* Campo "Codice casa" in sola lettura (visibile) */
      .bb-readonly { background:#f6f7f9; color:#555; pointer-events:none; }
      .bb-inline { display:inline-flex; gap:.5rem; align-items:center; width:100%; }
      .bb-copy { padding:.35rem .6rem; border:1px solid #ccc; border-radius:.4rem; background:#fff; cursor:pointer; }
    </style>
  </head>
  <body>
    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!-- Netlify Identity (login/signup) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        if (!window.netlifyIdentity) return;
        window.netlifyIdentity.init();
        var hash = window.location.hash || '';
        if (hash.includes('invite_token') || hash.includes('confirmation_token')) {
          window.netlifyIdentity.open('signup');
        }
        window.netlifyIdentity.on('login',  () => window.location.reload());
        window.netlifyIdentity.on('signup', () => window.location.reload());
      });
    </script>
    <button id="idBtn" style="position:fixed;right:16px;bottom:16px;padding:.6rem 1rem;border:1px solid #ddd;border-radius:.4rem;background:#fff;cursor:pointer;z-index:9999;">
      Accedi / Registrati
    </button>
    <script>document.getElementById('idBtn').onclick=()=>window.netlifyIdentity&&window.netlifyIdentity.open();</script>

    <!-- Script principale -->
    <script>
      (function () {
        // ---------- Utilità ----------
        const PREFIX = 'BB';
        const MONTH = { A:1,B:2,C:3,D:4,E:5,H:6,L:7,M:8,P:9,R:10,S:11,T:12 };
        const ODD = { '0':1,'1':0,'2':5,'3':7,'4':9,'5':13,'6':15,'7':17,'8':19,'9':21,
          A:1,B:0,C:5,D:7,E:9,F:13,G:15,H:17,I:19,J:21,K:2,L:4,M:18,N:20,O:11,P:3,Q:6,R:8,S:12,T:14,U:16,V:10,W:22,X:25,Y:24,Z:23 };
        const EVEN = { '0':0,'1':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,
          A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25 };

        function norm(s){return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Za-z0-9]/g,'').toUpperCase();}
        function fnv1a(str){let h=0x811c9dc5>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=(h+(h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24))>>>0;}return h>>>0;}
        function parseDMY(dmy){if(!/^\d{2}\/\d{2}\/\d{4}$/.test(dmy||''))return null;const d=+dmy.slice(0,2),m=+dmy.slice(3,5),y=+dmy.slice(6,10);if(m<1||m>12||d<1||d>31)return null;return {d,m,y};}
        function cfChecksum(cf15){let s=0;for(let i=0;i<15;i++){const c=cf15[i];if(!c)return null;s+=((i%2)===0?ODD[c]:EVEN[c]);}return String.fromCharCode((s%26)+65);}
        function validateCF(cf,dmy,gender){
          const out={valid:false,message:""};
          if(!cf||!/^[A-Z0-9]{16}$/i.test(cf)){out.message="Formato CF non valido (16 caratteri).";return out;}
          cf=cf.toUpperCase();
          const expected=cfChecksum(cf.slice(0,15)); if(!expected||expected!==cf[15]){out.message="Carattere di controllo CF non valido.";return out;}
          const p=parseDMY(dmy); if(!p||!gender){out.message="Inserisci data (dd/mm/yyyy) e sesso.";return out;}
          const yy=String(p.y).slice(2,4), cfYY=cf.slice(6,8), cfM=cf[8], cfDD=+cf.slice(9,11);
          if(cfYY!==yy){out.message="CF non coincide con anno.";return out;}
          if(MONTH[cfM]!==p.m){out.message="CF non coincide con mese.";return out;}
          const dd=(gender==='F')?(p.d+40):p.d; if(cfDD!==dd){out.message="CF non coincide con giorno/sesso.";return out;}
          out.valid=true; return out;
        }
        function buildHouseCode(p){
          const nZip=norm(p.zip).slice(0,5).padEnd(5,'0');
          const nCity=norm(p.city).slice(0,3).padEnd(3,'X');
          const base=[norm(p.region),norm(p.zip),norm(p.city),norm(p.street),norm(p.number),norm(p.owner_cf)].join('|');
          const hash5=fnv1a(base).toString(36).toUpperCase().slice(0,5).padStart(5,'0');
          return `${PREFIX}-${nZip}-${nCity}-${hash5}`;
        }

        // Trova input/select dal label
        function findFieldByLabelIncludes(text){
          const labels=[...document.querySelectorAll('label')];
          const lab=labels.find(l=>l.textContent&&l.textContent.trim().toLowerCase().includes(text.toLowerCase()));
          if(!lab) return null;
          const wrap=lab.closest('[class*="ControlContainer"]')||lab.parentElement;
          return wrap ? wrap.querySelector('input,select') : null;
        }

        // Imposta valore compatibile con React/Decap
        function setReactValueSafely(el, value){
          if (el.__bbSetting) return;
          const setter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value').set;
          el.__bbSetting = true;
          setter.call(el, value);
          el.dispatchEvent(new Event('input', { bubbles: true }));
          setTimeout(()=>{ el.__bbSetting = false; }, 0);
        }

        // Maschera data dd/mm/yyyy con slash automatici + salvataggio persistente
        function attachBirthMask(){
          const el = findFieldByLabelIncludes('Data di nascita');
          if (!el) return;
          el.placeholder='gg/mm/aaaa';

          const mask = (v)=>{
            v = (v||'').replace(/[^\d]/g,'').slice(0,8);
            if (v.length>=5) return v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4);
            if (v.length>=3) return v.slice(0,2)+'/'+v.slice(2);
            return v;
          };

          const onInput = ()=> {
            if (el.__bbSetting) return;
            const m = mask(el.value);
            if (el.value !== m) setReactValueSafely(el, m);
          };
          const onBlur = ()=> {
            if (el.__bbSetting) return;
            const m = mask(el.value);
            if (el.value !== m) setReactValueSafely(el, m);
          };
          const onPaste = (e)=> {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text') || '';
            setReactValueSafely(el, mask(text));
          };

          el.addEventListener('input', onInput);
          el.addEventListener('blur', onBlur);
          el.addEventListener('paste', onPaste);
        }

        // ---------- Autocomplete Città/Via con OpenStreetMap ----------
        function attachDatalist(input,id){ if(!input) return null; let dl=document.getElementById(id); if(!dl){dl=document.createElement('datalist');dl.id=id;document.body.appendChild(dl);} input.setAttribute('list',id); return dl; }
        function setOptions(dl,arr){ if(!dl) return; dl.innerHTML=''; (arr||[]).forEach(v=>{const o=document.createElement('option');o.value=v;dl.appendChild(o);}); }
        function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

        async function osmCitySuggest(q,region){
          if(!q||q.length<1) return []; // 1 lettera basta
          const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&accept-language=it&countrycodes=it&limit=8&q=${encodeURIComponent(q)}`;
          try{
            const r=await fetch(url);
            const js=await r.json();
            const allowed=new Set(['city','town','village','hamlet','municipality']);
            const out=[];
            for(const it of js){
              const city=it.address.city||it.address.town||it.address.village||it.address.hamlet||it.address.municipality;
              const reg =it.address.state||it.address.region;
              const ok=allowed.has(it.type);
              if(ok&&city){
                if(region&&reg&&reg.toLowerCase().indexOf(region.toLowerCase())===-1) continue;
                out.push(city);
              }
            }
            return [...new Set(out)].slice(0,12);
          }catch(e){ return []; }
        }

        async function osmStreetSuggest(q,city){
          if(!q||q.length<1||!city) return []; // 1 lettera basta
          const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&accept-language=it&countrycodes=it&limit=10&q=${encodeURIComponent(q+', '+city+', Italia')}`;
          try{
            const r=await fetch(url);
            const js=await r.json();
            const out=[];
            for(const it of js){
              const road=it.address.road||it.address.pedestrian||it.address.footway||it.address.path||it.address.cycleway||'';
              if(road) out.push(road);
            }
            return [...new Set(out)].slice(0,12);
          }catch(e){ return []; }
        }

        async function loadExisting(){ try{ const r=await fetch('/houses.json',{cache:'no-store'}); return await r.json(); } catch(e){ return { items:[] }; } }

        async function setupAutocomplete(){
          attachBirthMask();
          lockAllCodeFields();

          const regionSel = findFieldByLabelIncludes('Regione');   // select
          const cityInput = findFieldByLabelIncludes('Città');
          const streetInp = findFieldByLabelIncludes('Via');
          const numInput  = findFieldByLabelIncludes('Civico');

          const dlCities  = attachDatalist(cityInput,'dl-cities');
          const dlStreets = attachDatalist(streetInp,'dl-streets');
          const dlNums    = attachDatalist(numInput,'dl-nums');

          const existing = await loadExisting();
          const items = Array.isArray(existing.items) ? existing.items : [];

          function setOptionsUnique(dl, arr){ setOptions(dl, [...new Set(arr||[])].slice(0,20)); }
          function refreshNumbers(){
            const city=(cityInput?.value||'').trim();
            const nums=[...new Set(items.filter(x=>(x.city||'')===city).map(x=>(x.number||'').trim()).filter(Boolean))].sort();
            setOptionsUnique(dlNums, nums);
          }

          const suggestCities = debounce(async ()=>{
            const q=(cityInput?.value||'').trim(); const region=regionSel?regionSel.value:'';
            const osm=await osmCitySuggest(q,region);
            const fromData=[...new Set(items.filter(x=>!q||x.city.toLowerCase().includes(q.toLowerCase())).map(x=>x.city))];
            setOptionsUnique(dlCities, [...(osm||[]), ...(fromData||[])]);
            refreshNumbers();
          }, 350);

          const suggestStreets = debounce(async ()=>{
            const q=(streetInp?.value||'').trim(); const city=(cityInput?.value||'').trim();
            const osm=await osmStreetSuggest(q,city);
            const fromData=[...new Set(items.filter(x=>(!q||(x.street||'').toLowerCase().includes(q.toLowerCase()))&&(!city||x.city===city)).map(x=>x.street).filter(Boolean))];
            setOptionsUnique(dlStreets, [...(osm||[]), ...(fromData||[])]);
            refreshNumbers();
          }, 350);

          regionSel && regionSel.addEventListener('change', ()=>{ suggestCities(); suggestStreets(); updateHouseCode(); });
          cityInput && cityInput.addEventListener('input', ()=>{ suggestCities(); suggestStreets(); updateHouseCode(); });
          streetInp && streetInp.addEventListener('input', ()=>{ suggestStreets(); updateHouseCode(); });
          numInput && numInput.addEventListener('input', updateHouseCode);

          // anche ZIP/CF/sesso/data impattano il codice
          const zipInput    = findFieldByLabelIncludes('CAP');
          const cfInput     = findFieldByLabelIncludes('Codice fiscale');
          const genderInput = findFieldByLabelIncludes('Sesso');

          zipInput    && zipInput.addEventListener('input', updateHouseCode);
          cfInput     && cfInput.addEventListener('input', updateHouseCode);
          genderInput && genderInput.addEventListener('change', updateHouseCode);

          suggestCities(); suggestStreets(); refreshNumbers();
          updateHouseCode(); // prima computazione
        }

        // ---------- Lock "Codice casa" e pulsante copia ----------
        function lockAllCodeFields(){
          const labels=[...document.querySelectorAll('label')];
          labels.forEach(lab=>{
            if(lab.textContent && lab.textContent.trim().toLowerCase().includes('codice casa')){
              const wrap=lab.closest('[class*="ControlContainer"]')||lab.parentElement;
              if(!wrap) return;
              const input=wrap.querySelector('input');
              if(!input) return;

              if(input.dataset.bbLocked==='1') return;
              input.dataset.bbLocked='1';

              input.readOnly = true;
              input.setAttribute('aria-readonly','true');
              input.classList.add('bb-readonly');

              input.addEventListener('keydown', (e)=>{
                const ok=['Tab','Shift','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Home','End'];
                if(!e.ctrlKey && !e.metaKey && !ok.includes(e.key)) e.preventDefault();
              });
              input.addEventListener('beforeinput', (e)=> e.preventDefault());
              input.addEventListener('paste', (e)=> e.preventDefault());

              // bottone copia
              if(!wrap.querySelector('.bb-copy')){
                const inline=document.createElement('div'); inline.className='bb-inline';
                input.parentNode.insertBefore(inline,input);
                inline.appendChild(input);
                const btn=document.createElement('button'); btn.type='button'; btn.className='bb-copy'; btn.textContent='Copia';
                btn.onclick=()=>{ input.select(); document.execCommand('copy'); btn.textContent='Copiato!'; setTimeout(()=>btn.textContent='Copia',1200); };
                inline.appendChild(btn);
              }
            }
          });
        }

        // ---------- Generazione "live" del Codice casa ----------
        function updateHouseCode(){
          const region  = findFieldByLabelIncludes('Regione')?.value || '';
          const city    = findFieldByLabelIncludes('Città')?.value || '';
          const zip     = findFieldByLabelIncludes('CAP')?.value || '';
          const street  = findFieldByLabelIncludes('Via')?.value || '';
          const number  = findFieldByLabelIncludes('Civico')?.value || '';
          const cf      = (findFieldByLabelIncludes('Codice fiscale')?.value || '').toUpperCase();
          const birth   = findFieldByLabelIncludes('Data di nascita')?.value || '';
          const gender  = findFieldByLabelIncludes('Sesso')?.value || '';

          const codeEl  = findFieldByLabelIncludes('Codice casa');
          if (!codeEl) return;

          // Genera solo quando i dati minimi ci sono e CF è valido
          const mandatoryOk = region && city && zip && street && number && cf && birth && gender;
          if (!mandatoryOk) { setReactValueSafely(codeEl, ''); return; }

          const cfCheck = validateCF(cf, birth, gender);
          if (!cfCheck.valid) { setReactValueSafely(codeEl, ''); return; }

          const payload = { region, city, zip, street, number, owner_cf: cf };
          const code = buildHouseCode(payload);
          if (codeEl.value !== code) setReactValueSafely(codeEl, code);
        }

        // ---------- Regole di salvataggio/pubblicazione ----------
        CMS.registerEventListener({
          name:'preSave',
          handler:({entry,collection})=>{
            if(!collection||collection.get('name')!=='houses') return;
            // prova a generare il codice prima di salvare
            updateHouseCode();
          }
        });

        CMS.registerEventListener({
          name:'prePublish',
          handler:({entry,collection})=>{
            if(!collection||collection.get('name')!=='houses') return;
            // deve esserci un codice valido in ogni riga
            const items = entry.get('data')?.get?.('items') || [];
            for(let i=0;i<items.size;i++){
              const it=items.get(i);
              const code = String(it.get('code')||'');
              if(!code){ alert("Codice casa mancante alla riga "+(i+1)+". Completa i dati e il CF."); throw new Error("code mancante"); }
              if(!code.startsWith(PREFIX+'-')){ alert("Codice casa non valido alla riga "+(i+1)); throw new Error("code invalido"); }
            }
          }
        });

        // Observer: applica maschera/lock/bind ogni volta che il form cambia
        const obs = new MutationObserver(()=>{ 
          requestAnimationFrame(()=>{ 
            attachBirthMask(); 
            lockAllCodeFields(); 
            updateHouseCode();
          });
        });
        obs.observe(document.body, { childList:true, subtree:true });

        // Primo setup
        document.addEventListener('DOMContentLoaded', ()=>{ attachBirthMask(); lockAllCodeFields(); });
      })();
    </script>
  </body>
</html>
