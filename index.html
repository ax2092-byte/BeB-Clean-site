<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin — B&B Clean</title>
    <link rel="icon" type="image/png" href="../favicon.png">
    <style>
      /* Campo "Codice casa" in sola lettura (visibile) */
      .bb-readonly { background:#f6f7f9; color:#555; pointer-events:none; }

      /* Autocomplete custom (leggero) */
      .bb-ac-panel {
        position: absolute; z-index: 99999; min-width: 240px; max-width: 520px;
        max-height: 240px; overflow: auto; background: #fff; border: 1px solid #ddd;
        border-radius: .5rem; box-shadow: 0 10px 22px rgba(0,0,0,.08);
        font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }
      .bb-ac-item { padding: .5rem .75rem; cursor: pointer; }
      .bb-ac-item:hover, .bb-ac-item.active { background: #f2f4f7; }
      .bb-ac-empty { padding: .5rem .75rem; color: #666; }
      .bb-ac-spinner { padding: .5rem .75rem; color: #666; font-style: italic; }

      .bb-inline { display:inline-flex; gap:.5rem; align-items:center; width:100%; }
      .bb-copy { padding:.35rem .6rem; border:1px solid #ccc; border-radius:.4rem; background:#fff; cursor:pointer; }

      /* Visual: tutti i testi in maiuscolo */
      .bb-uppercase { text-transform: uppercase; }
    </style>
  </head>
  <body>
    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!-- Netlify Identity (login/signup) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        if (!window.netlifyIdentity) return;
        window.netlifyIdentity.init();
        var hash = window.location.hash || '';
        if (hash.includes('invite_token') || hash.includes('confirmation_token')) {
          window.netlifyIdentity.open('signup');
        }
        window.netlifyIdentity.on('login',  () => window.location.reload());
        window.netlifyIdentity.on('signup', () => window.location.reload());
      });
    </script>
    <button id="idBtn" style="position:fixed;right:16px;bottom:16px;padding:.6rem 1rem;border:1px solid #ddd;border-radius:.4rem;background:#fff;cursor:pointer;z-index:9999;">
      Accedi / Registrati
    </button>
    <script>document.getElementById('idBtn').onclick=()=>window.netlifyIdentity&&window.netlifyIdentity.open();</script>

    <!-- Script principale -->
    <script>
      (function () {
        // ================== UTILITÀ BASE ==================
        const REG_LETTER = {
          "ABRUZZO":"A","BASILICATA":"B","CALABRIA":"C","CAMPANIA":"D","EMILIA-ROMAGNA":"E",
          "FRIULI-VENEZIA GIULIA":"F","LAZIO":"G","LIGURIA":"H","LOMBARDIA":"I","MARCHE":"J",
          "MOLISE":"K","PIEMONTE":"L","PUGLIA":"M","SARDEGNA":"N","SICILIA":"O",
          "TOSCANA":"P","TRENTINO-ALTO ADIGE":"Q","UMBRIA":"R","VALLE D'AOSTA":"S","VENETO":"T"
        };

        function removeDiacritics(str){
          return (str||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        }
        function onlyLetters(str){ return removeDiacritics(str).replace(/[^A-Z]/g,''); }
        function toUC(str){ return removeDiacritics((str||'')+'').toUpperCase(); }

        // Estrae prime N lettere (A-Z), paddando con X se mancano
        function firstNLetters(str, n){
          const s = onlyLetters(toUC(str));
          return (s.slice(0,n)+'X'.repeat(n)).slice(0,n);
        }

        // Pulisce il nome via/piazza togliendo prefissi iniziali e prende il "core"
        function streetCore(str){
          const up = toUC(str).trim();
          const prefixes = [
            'VIA','VIALE','VICO','VICOLO','CORSO','LARGO','STRADA','PIAZZA','P.ZZA','PZZA','P.ZZ','PZ.','PZ','P/ZA'
          ];
          let s = up.replace(/^\s+/, '');
          for (const pref of prefixes){
            const re = new RegExp('^' + pref + '\\b\\s*');
            if (re.test(s)) { s = s.replace(re,''); break; }
          }
          return s.trim();
        }

        // CAP invertito (solo cifre, invertite)
        function reverseCAP(zip){
          const digits = (zip||'').replace(/\D/g,'');
          return digits.split('').reverse().join('');
        }

        // Giorno da data dd/mm/yyyy
        function dayFromDate(dmy){
          const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(dmy||'');
          return m ? m[1] : '';
        }

        // Costruisce il codice casa secondo le nuove regole
        function makeHouseCode({ cf, prov, street, number, zip, birth, region, city }){
          const CF3   = firstNLetters(cf, 3);
          const PROV2 = firstNLetters(prov, 2);
          const STR3  = firstNLetters(streetCore(street), 3);
          const CIV   = toUC(number).replace(/\s+/g,''); // può contenere lettere/numeri
          const CAPR  = reverseCAP(zip);
          const DAY   = dayFromDate(birth); // 2 cifre
          const REG   = REG_LETTER[toUC(region)] || 'Z'; // fallback Z se non trovata
          const CIT3  = firstNLetters(city, 3);

          if (!(CF3 && PROV2 && STR3 && CIV && CAPR && DAY && REG && CIT3)) return '';
          return [CF3, PROV2, STR3, CIV, CAPR, DAY, REG, CIT3].join('-');
        }

        // Trova input/select per etichetta, all’interno di un container (riga) se passato
        function getInputByLabel(labelText, root=document){
          const labels=[...root.querySelectorAll('label')];
          const lab=labels.find(l=>l.textContent && l.textContent.trim().toUpperCase().includes(labelText.toUpperCase()));
          if(!lab) return null;
          const wrap=lab.closest('[class*="ControlContainer"]')||lab.parentElement;
          return wrap ? (wrap.querySelector('input,select')||null) : null;
        }

        // Trova il container “riga” (blocchetto della casa corrente)
        function findRowRoot(fromEl){
          let p = fromEl;
          while (p && p !== document.body) {
            if (getInputByLabel('Codice casa', p)) return p;
            p = p.parentElement;
          }
          return document;
        }

        // Imposta valore compatibile con React/Decap (input o select)
        function setReactValue(el, value){
          if (!el) return;
          if (el.nodeName === 'SELECT') {
            const setter = Object.getOwnPropertyDescriptor(HTMLSelectElement.prototype, 'value').set;
            setter.call(el, value);
            el.dispatchEvent(new Event('change', { bubbles: true }));
          } else {
            const setter = Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, 'value').set;
            setter.call(el, value);
            el.dispatchEvent(new Event('input', { bubbles: true }));
          }
        }

        // ================== MAIUSCOLO FORZATO ==================
        function enforceUppercase(root){
          const inputs = [...root.querySelectorAll('input[type="text"], input:not([type])')];
          inputs.forEach(inp=>{
            if (inp._bbUC) return;
            inp._bbUC = true;

            // non forzare sul campo data e sul "Codice casa"
            const isDate   = /data di nascita/i.test(inp.closest('label, [class]').textContent || '');
            const isCode   = /codice casa/i.test(inp.closest('label, [class]').textContent || '');

            // aspetto visuale
            inp.classList.add('bb-uppercase');

            if (!isCode && !isDate){
              inp.addEventListener('input', ()=>{
                const up = toUC(inp.value);
                if (inp.value !== up) setReactValue(inp, up);
              });
              inp.addEventListener('blur', ()=>{
                const up = toUC(inp.value);
                if (inp.value !== up) setReactValue(inp, up);
              });
              // paste
              inp.addEventListener('paste', (e)=>{
                e.preventDefault();
                const t=(e.clipboardData||window.clipboardData).getData('text')||'';
                setReactValue(inp, toUC(t));
              });
            }
          });
        }

        // ================== MASCHERA DATA ==================
        function attachBirthMask(root){
          const el = getInputByLabel('Data di nascita', root);
          if (!el || el._bbMasked) return;
          el._bbMasked = true;
          el.placeholder='gg/mm/aaaa';
          const mask = (v)=>{
            v = (v||'').replace(/[^\d]/g,'').slice(0,8);
            if (v.length>=5) return v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4);
            if (v.length>=3) return v.slice(0,2)+'/'+v.slice(2);
            return v;
          };
          el.addEventListener('input', ()=>{
            const m = mask(el.value);
            if (el.value !== m) setReactValue(el, m);
          });
          el.addEventListener('blur', ()=>{
            const m = mask(el.value);
            if (el.value !== m) setReactValue(el, m);
          });
          el.addEventListener('paste', (e)=>{
            e.preventDefault();
            const t=(e.clipboardData||window.clipboardData).getData('text')||'';
            setReactValue(el, mask(t));
          });
        }

        // ================== BLOCCO CAMPO CODICE ==================
        function lockCodeField(root){
          const el = getInputByLabel('Codice casa', root);
          if (!el || el._bbLocked) return;
          el._bbLocked = true;
          el.readOnly = true;
          el.setAttribute('aria-readonly','true');
          el.classList.add('bb-readonly');
          el.addEventListener('keydown', (e)=>{
            const ok=['Tab','Shift','ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Home','End'];
            if(!e.ctrlKey && !e.metaKey && !ok.includes(e.key)) e.preventDefault();
          });
          el.addEventListener('beforeinput', (e)=> e.preventDefault());
          el.addEventListener('paste', (e)=> e.preventDefault());

          // bottone copia
          const parent = el.parentElement;
          if (parent && !parent.querySelector('.bb-copy')){
            const wrap = document.createElement('div'); wrap.className='bb-inline';
            parent.insertBefore(wrap, el);
            wrap.appendChild(el);
            const btn=document.createElement('button'); btn.type='button'; btn.className='bb-copy'; btn.textContent='Copia';
            btn.onclick=()=>{ el.select(); document.execCommand('copy'); btn.textContent='Copiato!'; setTimeout(()=>btn.textContent='Copia',1200); };
            wrap.appendChild(btn);
          }
        }

        // ================== AUTOCOMPLETE (leggero, con cache e abort) ==================
        const cityCache = new Map();   // key: region|q
        const streetCache = new Map(); // key: city|q

        function createPanel(){ const p=document.createElement('div'); p.className='bb-ac-panel'; p.style.display='none'; document.body.appendChild(p); return p; }
        function positionPanel(panel, input){
          const r=input.getBoundingClientRect();
          panel.style.left = (window.scrollX + r.left) + 'px';
          panel.style.top  = (window.scrollY + r.bottom + 4) + 'px';
          panel.style.minWidth = r.width + 'px';
          panel.style.display='block';
        }
        function fillPanel(panel, items, onPick){
          panel.innerHTML='';
          if (!items || !items.length){ const d=document.createElement('div'); d.className='bb-ac-empty'; d.textContent='Nessun risultato'; panel.appendChild(d); return; }
          items.forEach(v=>{
            const it=document.createElement('div'); it.className='bb-ac-item'; it.textContent=v;
            it.onmousedown=(e)=>{ e.preventDefault(); onPick(v); panel.style.display='none'; };
            panel.appendChild(it);
          });
        }
        function showSpinner(panel){ panel.innerHTML='<div class="bb-ac-spinner">Sto cercando…</div>'; }

        async function fetchCities(q, region, signal){
          if (!q || q.length < 2) return [];
          const key=(region||'')+'|'+q.toUpperCase();
          if (cityCache.has(key)) return cityCache.get(key);

          const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&accept-language=it&countrycodes=it&limit=12&q=${encodeURIComponent(q)}`;
          try{
            const r=await fetch(url, { signal });
            const js=await r.json();
            const allowed=new Set(['city','town','village','hamlet','municipality']);
            const out=[];
            for(const it of js){
              const city=(it.address.city||it.address.town||it.address.village||it.address.hamlet||it.address.municipality||'').toUpperCase();
              const reg =(it.address.state||it.address.region||'').toUpperCase();
              if (allowed.has(it.type) && city){
                const score = (region && reg.includes(region.toUpperCase())) ? 0 : 1;
                out.push({city, score});
              }
            }
            out.sort((a,b)=>a.score-b.score);
            const names=[...new Set(out.map(o=>o.city))].slice(0,12);
            cityCache.set(key, names);
            return names;
          }catch(e){
            cityCache.set(key, []);
            return [];
          }
        }

        async function fetchStreets(q, city, signal){
          if (!q || q.length < 2 || !city) return [];
          const key=(city||'')+'|'+q.toUpperCase();
          if (streetCache.has(key)) return streetCache.get(key);

          const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&accept-language=it&countrycodes=it&limit=12&q=${encodeURIComponent(q+', '+city+', Italia')}`;
          try{
            const r=await fetch(url, { signal });
            const js=await r.json();
            const out=[];
            for(const it of js){
              const road=(it.address.road||it.address.pedestrian||it.address.footway||it.address.path||it.address.cycleway||'').toUpperCase();
              if (road) out.push(road);
            }
            const names=[...new Set(out)].slice(0,12);
            streetCache.set(key, names);
            return names;
          }catch(e){
            streetCache.set(key, []);
            return [];
          }
        }

        function attachAutocomplete(input, getParams, onPick){
          if (!input) return;
          if (input._bbAc) return;  // già collegato
          input._bbAc = { panel: createPanel(), ctrl: null, lastQ: null };

          const run = debounce(async ()=>{
            const q=input.value.trim().toUpperCase();
            const { type, region, city } = getParams();

            if (input._bbAc.lastQ === q) {
              input._bbAc.panel.style.display = 'block';
              positionPanel(input._bbAc.panel, input);
              return;
            }
            input._bbAc.lastQ = q;

            if (input._bbAc.ctrl) input._bbAc.ctrl.abort();
            const ctrl = new AbortController(); input._bbAc.ctrl = ctrl;

            positionPanel(input._bbAc.panel, input);
            showSpinner(input._bbAc.panel);

            let items=[];
            if (type==='city')   items = await fetchCities(q, region, ctrl.signal);
            if (type==='street') items = await fetchStreets(q, city,   ctrl.signal);

            if (ctrl.signal.aborted || input.value.trim().toUpperCase() !== q) return;
            fillPanel(input._bbAc.panel, items, (val)=> onPick(val) );
          }, 280);

          input.addEventListener('input', ()=>{
            // forza maiuscolo live
            const up = toUC(input.value);
            if (input.value !== up) setReactValue(input, up);
            positionPanel(input._bbAc.panel, input);
            run();
          });
          input.addEventListener('focus', ()=>{ positionPanel(input._bbAc.panel, input); run(); });
          input.addEventListener('keydown', (e)=>{ if (e.key==='Escape'){ input._bbAc.panel.style.display='none'; }});
          document.addEventListener('click', (e)=>{ if (!input._bbAc.panel.contains(e.target) && e.target!==input) input._bbAc.panel.style.display='none'; });
        }

        // ================== GENERAZIONE CODICE (PER-RIGA) ==================
        function updateCodeForRow(root){
          const region = (getInputByLabel('Regione', root)?.value || '');
          const city   = (getInputByLabel('Città',   root)?.value || '');
          const prov   = (getInputByLabel('Provincia', root)?.value || '');
          const zip    = (getInputByLabel('CAP',     root)?.value || '');
          const street = (getInputByLabel('Via/Piazza', root)?.value || getInputByLabel('Via', root)?.value || '');
          const number = (getInputByLabel('Civico',  root)?.value || '');
          const cf     = (getInputByLabel('Codice fiscale', root)?.value || '');
          const birth  = (getInputByLabel('Data di nascita', root)?.value || '');

          const codeEl = getInputByLabel('Codice casa', root);
          if (!codeEl) return;

          const code = makeHouseCode({ cf, prov, street, number, zip, birth, region, city });
          setReactValue(codeEl, code);
        }

        // ================== COLLEGAMENTO EVENTI PER-RIGA ==================
        function wireRow(root){
          enforceUppercase(root);
          attachBirthMask(root);
          lockCodeField(root);

          const region = getInputByLabel('Regione', root);
          const city   = getInputByLabel('Città',   root);
          const street = getInputByLabel('Via/Piazza', root) || getInputByLabel('Via', root);
          const num    = getInputByLabel('Civico',  root);
          const zip    = getInputByLabel('CAP',     root);
          const prov   = getInputByLabel('Provincia', root);
          const cf     = getInputByLabel('Codice fiscale', root);
          const birth  = getInputByLabel('Data di nascita', root);

          // Autocomplete Città
          attachAutocomplete(
            city,
            ()=>({ type:'city', region: region ? region.value : '' }),
            (val)=>{ setReactValue(city, val); updateCodeForRow(root); }
          );

          // Autocomplete Via/Piazza
          attachAutocomplete(
            street,
            ()=>({ type:'street', city: city ? city.value : '' }),
            (val)=>{ setReactValue(street, val); updateCodeForRow(root); }
          );

          // Eventi che rigenerano il codice
          [[region,'change'],[city,'input'],[prov,'input'],[zip,'input'],[street,'input'],[num,'input'],[cf,'input'],[birth,'input']].forEach(([el,ev])=>{
            if (el) el.addEventListener(ev, ()=> updateCodeForRow(root));
          });

          // Primo calcolo
          updateCodeForRow(root);
        }

        // ================== SCOPERTA AUTOMATICA DELLE RIGHE ==================
        function wireAllRows(){
          const labels=[...document.querySelectorAll('label')].filter(l=>l.textContent && /Codice casa/i.test(l.textContent));
          labels.forEach(lab=>{
            const root = findRowRoot(lab);
            if (root && !root._bbWired) {
              root._bbWired = true;
              wireRow(root);
            }
          });
        }

        // Hook Decap
        CMS.registerEventListener({ name:'preSave',   handler:()=>{ wireAllRows(); } });
        CMS.registerEventListener({
          name:'prePublish',
          handler:({entry,collection})=>{
            if(!collection||collection.get('name')!=='houses') return;
            wireAllRows();
            const items = entry.get('data')?.get?.('items') || [];
            for (let i=0;i<items.size;i++){
              const it=items.get(i);
              const code=String(it.get('code')||'');
              if(!code){ alert("Codice casa mancante alla riga "+(i+1)+"."); throw new Error("code mancante"); }
            }
          }
        });

        // Observer: Decap monta i campi in asincrono
        const obs = new MutationObserver(()=>{ requestAnimationFrame(()=>{ wireAllRows(); }); });
        obs.observe(document.body, { childList:true, subtree:true });

        document.addEventListener('DOMContentLoaded', ()=>{ wireAllRows(); });
      })();
    </script>
  </body>
</html>
