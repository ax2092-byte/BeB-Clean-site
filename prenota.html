<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prenota — B&B Clean</title>
  <meta name="description" content="Prenota una pulizia per casa o B&B. Stima trasparente prima della conferma.">
  <link rel="icon" href="/assets/img/favicon-32.png">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <style>
    :root{--brand:#0f9e9e;--brand-ink:#0a6f6f;--ink:#111827;--muted:#6b7280;--ring:#e5e7eb;--card:#f9fafb;--surface:#fff}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;color:var(--ink);background:var(--surface)}
    .container{width:min(1000px,92%);margin:0 auto}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
    .topbar .left{display:flex;align-items:center;gap:10px}
    .back-arrow{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:999px;border:1px solid var(--ring);text-decoration:none;color:var(--ink)}
    .back-arrow:hover{background:#f3f4f6}
    .logo{height:32px;display:block}
    .mainnav a{text-decoration:none;color:var(--ink);font-weight:700;margin-left:16px;padding:8px 12px;border-radius:12px}
    .mainnav a:hover{background:#f3f4f6}
    .mainnav a.active{background:#e6f5f5;color:var(--brand-ink)}
    .hero{padding:36px 0 8px}
    .hero h1{font-size:clamp(26px,4vw,36px);margin:0 0 8px}
    .hero .sub{color:var(--muted);margin:0}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:18px}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px}
    .field label{display:block;margin:8px 0 6px;font-weight:600}
    .field input, .field select{width:100%;padding:12px;border:1px solid var(--ring);border-radius:12px}
    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer}
    .muted{color:var(--muted)}
    .h4{font-size:22px;font-weight:800}
    .h5{font-size:18px;margin:14px 0 6px}
    .mt-24{margin-top:24px}
    .actions{display:flex;gap:12px;flex-wrap:wrap}
    .btn{display:inline-block;border:1px solid var(--ring);padding:12px 16px;border-radius:14px;text-decoration:none;font-weight:700}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.primary:disabled{opacity:.6;cursor:not-allowed}
    .summary-kv{display:flex;flex-wrap:wrap;gap:10px 16px}
    .summary-kv .kv{background:#fff;border:1px solid var(--ring);border-radius:12px;padding:8px 10px}
    .summary-kv .kv .k{color:var(--muted);font-size:12px}
    .summary-kv .kv .v{font-weight:700}
    .notice{font-size:14px;color:var(--muted)}
    .price-note{margin-top:6px}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="topbar container" role="banner">
    <div class="left">
      <a id="back-link" class="back-arrow" href="#back" aria-label="Torna alla pagina precedente">←</a>
      <a href="/index.html" aria-label="B&B Clean — Home">
        <img class="logo" src="/assets/img/bbclean-logo-primary.png" alt="B&B Clean">
      </a>
    </div>
    <nav class="mainnav" aria-label="Menu principale">
      <a href="/index.html" data-page="home">HOME</a>
      <a href="/prenota.html" data-page="prenota">PRENOTA</a>
      <a href="/servizi.html" data-page="servizi">I NOSTRI SERVIZI</a>
      <a href="/partner.html" data-page="partner">DIVENTA PARTNER</a>
    </nav>
  </header>

  <!-- HERO -->
  <section class="hero container">
    <h1>Prenota una pulizia</h1>
    <p class="sub">Conferma i dettagli, scegli gli extra e invia la richiesta.</p>
  </section>

  <!-- RIEPILOGO INDIRIZZO (dalla stima) -->
  <section class="container">
    <div class="card" id="summary-address" style="display:none">
      <div class="summary-kv" id="summary-kv"></div>
    </div>
  </section>

  <!-- FORM NETLIFY -->
  <main class="container">
    <form id="form-prenota" class="card"
          name="prenota"
          method="POST"
          action="/success.html"
          data-netlify="true"
          netlify-honeypot="bot-field">
      <input type="hidden" name="form-name" value="prenota">
      <input type="hidden" name="bot-field">

      <!-- info partner/prezzi -->
      <input type="hidden" name="partner_id" id="nf-partner-id">
      <input type="hidden" name="prezzi_fonte" id="nf-prezzi-fonte" value="consigliati">
      <input type="hidden" name="extras" id="nf-extras">
      <input type="hidden" name="email" id="nf-email">

      <h2 class="h5">Dati dell’alloggio</h2>
      <div class="grid-2">
        <div class="field">
          <label for="regione">Regione</label>
          <input type="text" id="regione" name="regione" placeholder="es. Sardegna" required>
        </div>
        <div class="field">
          <label for="citta">Città</label>
          <input type="text" id="citta" name="citta" placeholder="es. Nuoro" required>
        </div>
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="indirizzo">Indirizzo</label>
          <input type="text" id="indirizzo" name="indirizzo" placeholder="es. Via Bologna" required>
        </div>
        <div class="field">
          <label for="civico">Numero civico</label>
          <input type="text" id="civico" name="civico" placeholder="es. 10" required>
        </div>
      </div>

      <div class="grid-3">
        <div class="field">
          <label for="mq">Metri quadri (mq)</label>
          <input type="number" id="mq" name="mq" min="10" max="400" step="1" placeholder="es. 70" required>
        </div>
        <div class="field">
          <label for="bagni">Quantità di bagni</label>
          <input type="number" id="bagni" name="bagni" min="1" max="10" step="1" placeholder="es. 1" required>
        </div>
        <div class="field">
          <label for="cucina">Cucina</label>
          <select id="cucina" name="cucina" required>
            <option value="">Seleziona…</option>
            <option value="si">Sì</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="camere_letto">Camere da letto</label>
          <input type="number" id="camere_letto" name="camere_letto" min="1" max="10" step="1" placeholder="es. 2" required>
        </div>
        <div class="field">
          <label for="stanze">Numero di stanze (opzionale)</label>
          <input type="number" id="stanze" name="stanze" min="1" max="15" step="1" placeholder="es. 4">
        </div>
      </div>

      <h2 class="h5 mt-24">Extra su richiesta</h2>
      <div id="extra-list" class="chips">
        <!-- Prezzi consigliati (override dal partner se presente) -->
        <label class="chip">
          <input type="checkbox" class="extra" value="cambio_biancheria" data-minutes="15" data-price="4">
          <span data-label="cambio_biancheria">Cambio biancheria · 4€</span>
        </label>

        <label class="chip">
          <input type="checkbox" class="extra" value="forno" data-minutes="20" data-price="7.5">
          <span data-label="forno">Forno · 7,50€</span>
        </label>

        <label class="chip">
          <input type="checkbox" class="extra" value="frigo" data-minutes="15" data-price="6">
          <span data-label="frigo">Frigo · 6€</span>
        </label>

        <label class="chip">
          <input type="checkbox" class="extra" value="vetri" data-minutes="25" data-price="8">
          <span data-label="vetri">Vetri e infissi · 8€</span>
        </label>

        <label class="chip">
          <input type="checkbox" class="extra" value="balconi" data-minutes="20" data-price="12">
          <span data-label="balconi">Balconi / verande · 12€</span>
        </label>
      </div>
      <div class="notice price-note" id="price-note">
        Prezzi extra consigliati da B&B Clean. Il partner può applicare prezzi propri.
      </div>

      <div class="card mt-24" id="box-stima" aria-live="polite">
        <div class="grid-3">
          <div><div class="muted">Durata stimata</div><div class="h4" id="durata">—</div></div>
          <div><div class="muted">Costo del servizio B&B Clean</div><div class="h4" id="costo">—</div></div>
          <div><div class="muted">Extra selezionati</div><div id="extra-riepilogo">Nessuno</div></div>
        </div>
        <small class="muted">La stima è indicativa e può variare in base alle esigenze reali. Vedrai il dettaglio prima della conferma.</small>
      </div>

      <div class="actions mt-24">
        <button type="submit" id="btn-prosegui" class="btn primary">Prosegui</button>
        <a href="/servizi.html" class="btn">I nostri servizi</a>
      </div>
    </form>
  </main>

  <footer class="container" style="border-top:1px solid var(--ring);margin-top:28px;padding:16px 0;color:var(--muted);font-size:14px">
    © 2025 B&B Clean — Il tuo tempo è il nostro lavoro!
  </footer>

  <!-- Script comune -->
  <script src="/assets/js/site.js" defer></script>

  <!-- Auth0 + guard + stato utente -->
  <script src="/assets/js/vendor/auth0-spa-js.production.js"></script>
  <script src="/assets/js/auth-config.js"></script>
  <script src="/assets/js/auth.js"></script>
  <script src="/assets/js/guard.js"></script>
  <script src="/assets/js/menu-auth.js"></script>

  <!-- Prefill + stima + prezzi partner -->
  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const euro = v => (v==null || isNaN(v)) ? '—' :
        new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(v);
      const roundHalf = num => Math.round(num*2)/2;

      // Prezzi consigliati default (possono essere sovrascritti dal partner)
      const defaultExtraPrices = {
        cambio_biancheria: 4,
        forno: 7.5,
        frigo: 6,
        vetri: 8,
        balconi: 12
      };

      // Aggiorna prezzo visuale + data-price
      function applyExtraPrices(prices, sourceLabel){
        $$('.extra').forEach(inp=>{
          const key = inp.value;
          const p = (prices && prices[key] != null) ? Number(prices[key]) : defaultExtraPrices[key];
          inp.dataset.price = String(p);
          const lab = document.querySelector('[data-label="'+key+'"]');
          if (lab) lab.textContent = labelText(key, p);
        });
        if (sourceLabel){
          $('#price-note').textContent = sourceLabel;
        }
        updateStima(); // ricalcola
      }

      // Etichetta umana per la chip
      function labelText(key, price){
        const map = {
          cambio_biancheria: 'Cambio biancheria',
          forno: 'Forno',
          frigo: 'Frigo',
          vetri: 'Vetri e infissi',
          balconi: 'Balconi / verande'
        };
        return map[key] + ' · ' + euro(price).replace(' €','€'); // compact
      }

      // STIMA
      const mph = 35;        // mq per ora (base)
      const baseRate = 18;   // €/h base (puoi modificarlo)
      function updateStima(){
        const mq = parseFloat($('#mq').value) || 0;
        const ore = Math.max(1, roundHalf(mq / mph));
        $('#durata').textContent = `${String(ore).replace('.',',')} h`;

        const extras = $$('.extra:checked');
        const extraSum = extras.reduce((acc,el)=> acc + (parseFloat(el.dataset.price)||0), 0);
        const costo = (ore * baseRate) + extraSum;
        $('#costo').textContent = euro(costo);

        const riepilogo = extras.length ? extras.map(e => {
          const key = e.value;
          const p = parseFloat(e.dataset.price)||0;
          return (labelText(key, p));
        }).join(', ') : 'Nessuno';
        $('#extra-riepilogo').textContent = riepilogo;

        // Compila hidden "extras" per Netlify (testuale)
        $('#nf-extras').value = extras.map(e=>{
          const key = e.value;
          const p = parseFloat(e.dataset.price)||0;
          return `${key}:${p}`;
        }).join('; ');
      }

      document.addEventListener('change', e=>{
        if (e.target && (e.target.id==='mq' || e.target.classList.contains('extra'))){
          updateStima();
        }
      });
      document.addEventListener('input', e=>{
        if (e.target && e.target.id==='mq'){ updateStima(); }
      });

      // PREFILL da query + user email
      document.addEventListener('DOMContentLoaded', async ()=>{
        const p = new URLSearchParams(location.search);
        const regione = p.get('regione')||'';
        const citta = p.get('citta')||'';
        const indirizzo = p.get('indirizzo')||'';
        const civico = p.get('civico')||'';
        const mq = p.get('mq')||'';
        // prefill visibili
        if (regione) $('#regione').value = regione;
        if (citta) $('#citta').value = citta;
        if (indirizzo) $('#indirizzo').value = indirizzo;
        if (civico) $('#civico').value = civico;
        if (mq) $('#mq').value = mq;

        // riepilogo
        const items = [];
        if (regione) items.push(['Regione', regione]);
        if (citta) items.push(['Città', citta]);
        if (indirizzo || civico) items.push(['Indirizzo', (indirizzo||'') + (civico? ' ' + civico : '')]);
        if (items.length){
          const wrap = $('#summary-address');
          const kv = $('#summary-kv');
          kv.innerHTML = items.map(([k,v])=>(
            `<div class="kv"><div class="k">${k}</div><div class="v">${v}</div></div>`
          )).join('');
          wrap.style.display = 'block';
        }

        // Email da Auth (se loggato)
        try{
          await window.Auth.ensureReady();
          if (await window.Auth.isAuthenticated()){
            const user = await window.Auth.getUser();
            if (user && user.email) $('#nf-email').value = user.email;
          }
        }catch(_){}

        // Prezzi consigliati di default
        applyExtraPrices(defaultExtraPrices, 'Prezzi extra consigliati da B&B Clean. Il partner può applicare prezzi propri.');

        // Override da partner (se presente)
        const partnerId = p.get('pid') || p.get('partner') || sessionStorage.getItem('stima_partner_id') || '';
        if (partnerId){
          try{
            const res = await fetch('/assets/data/partner.json',{cache:'no-store'});
            const partners = await res.json();
            const partner = Array.isArray(partners) ? partners.find(x => String(x.id||x.ID||x.slug||'') === String(partnerId)) : null;
            if (partner){
              $('#nf-partner-id').value = String(partnerId);
              const partnerPrices = partner.extra_prices || partner.extras || null;
              if (partnerPrices){
                applyExtraPrices(partnerPrices, 'Prezzi extra applicati dal partner.');
                $('#nf-prezzi-fonte').value = 'partner';
              }
            }
          }catch(e){
            // Se il file non è disponibile o non ha prezzi, restano i consigliati
          }
        }

        updateStima();
      });
    })();
  </script>
</body>
</html>
