<!-- FILE: /prenota.html  (Netlify Forms + prefill + stato utente + guard) -->
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prenota — B&B Clean</title>
  <meta name="description" content="Prenota una pulizia per casa o B&B. Stima trasparente prima della conferma.">
  <link rel="icon" href="/assets/img/favicon-32.png">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <style>
    :root{--brand:#0f9e9e;--brand-ink:#0a6f6f;--ink:#111827;--muted:#6b7280;--ring:#e5e7eb;--card:#f9fafb;--surface:#fff}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;color:var(--ink);background:var(--surface)}
    .container{width:min(1000px,92%);margin:0 auto}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
    .topbar .left{display:flex;align-items:center;gap:10px}
    .back-arrow{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:999px;border:1px solid var(--ring);text-decoration:none;color:var(--ink)}
    .back-arrow:hover{background:#f3f4f6}
    .logo{height:32px;display:block}
    .mainnav a{text-decoration:none;color:var(--ink);font-weight:700;margin-left:16px;padding:8px 12px;border-radius:12px}
    .mainnav a:hover{background:#f3f4f6}
    .mainnav a.active{background:#e6f5f5;color:var(--brand-ink)}
    .hero{padding:36px 0 8px}
    .hero h1{font-size:clamp(26px,4vw,36px);margin:0 0 8px}
    .hero .sub{color:var(--muted);margin:0}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:18px}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px}
    .field label{display:block;margin:8px 0 6px;font-weight:600}
    .field input{width:100%;padding:12px;border:1px solid var(--ring);border-radius:12px}
    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer}
    .muted{color:var(--muted)}
    .h4{font-size:22px;font-weight:800}
    .h5{font-size:18px;margin:14px 0 6px}
    .mt-24{margin-top:24px}
    .actions{display:flex;gap:12px;flex-wrap:wrap}
    .btn{display:inline-block;border:1px solid var(--ring);padding:12px 16px;border-radius:14px;text-decoration:none;font-weight:700}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.primary:disabled{opacity:.6;cursor:not-allowed}
    .summary-kv{display:flex;flex-wrap:wrap;gap:10px 16px}
    .summary-kv .kv{background:#fff;border:1px solid var(--ring);border-radius:12px;padding:8px 10px}
    .summary-kv .kv .k{color:var(--muted);font-size:12px}
    .summary-kv .kv .v{font-weight:700}
  </style>
</head>
<body>
  <header class="topbar container" role="banner">
    <div class="left">
      <a id="back-link" class="back-arrow" href="#back" aria-label="Torna alla pagina precedente">←</a>
      <a href="/index.html" aria-label="B&B Clean — Home">
        <img class="logo" src="/assets/img/bbclean-logo-primary.png" alt="B&B Clean">
      </a>
    </div>
    <nav class="mainnav" aria-label="Menu principale">
      <a href="/index.html" data-page="home">HOME</a>
      <a href="/prenota.html" data-page="prenota">PRENOTA</a>
      <a href="/servizi.html" data-page="servizi">I NOSTRI SERVIZI</a>
      <a href="/partner.html" data-page="partner">DIVENTA PARTNER</a>
    </nav>
  </header>

  <section class="hero container">
    <h1>Prenota una pulizia</h1>
    <p class="sub">Conferma i dettagli, scegli gli extra e invia la richiesta.</p>
  </section>

  <section class="container">
    <div class="card" id="summary-address" style="display:none">
      <div class="summary-kv" id="summary-kv"></div>
    </div>
  </section>

  <!-- Netlify Forms: name, method, data-netlify, honeypot, hidden form-name -->
  <main class="container">
    <form id="form-prenota" class="card"
          name="prenota"
          method="POST"
          action="/success.html"
          data-netlify="true"
          netlify-honeypot="bot-field">
      <input type="hidden" name="form-name" value="prenota">
      <input type="hidden" name="bot-field">
      <!-- campi hidden dalla stima / auth -->
      <input type="hidden" name="regione" id="nf-regione">
      <input type="hidden" name="citta" id="nf-citta">
      <input type="hidden" name="indirizzo" id="nf-indirizzo">
      <input type="hidden" name="email" id="nf-email">
      <input type="hidden" name="extras" id="nf-extras">

      <h2 class="h5">Dati dell’alloggio</h2>
      <div class="grid-2">
        <div class="field">
          <label for="mq">Metri quadri (mq)</label>
          <input type="number" id="mq" name="mq" min="10" max="400" step="1" placeholder="es. 70" required>
          <small class="muted">Inserisci la superficie calpestabile.</small>
        </div>
        <div class="field">
          <label for="stanze">Numero di stanze (opzionale)</label>
          <input type="number" id="stanze" name="stanze" min="1" max="15" step="1" placeholder="es. 3">
        </div>
      </div>

      <h2 class="h5 mt-24">Extra su richiesta</h2>
      <div id="extra-list" class="chips">
        <label class="chip"><input type="checkbox" class="extra" name="extra_cambio_biancheria" value="cambio_biancheria" data-minutes="15" data-price="5"><span>Cambio biancheria</span></label>
        <label class="chip"><input type="checkbox" class="extra" name="extra_forno" value="forno" data-minutes="20" data-price="10"><span>Forno</span></label>
        <label class="chip"><input type="checkbox" class="extra" name="extra_frigo" value="frigo" data-minutes="15" data-price="8"><span>Frigo</span></label>
        <label class="chip"><input type="checkbox" class="extra" name="extra_vetri" value="vetri" data-minutes="25" data-price="12"><span>Vetri e infissi</span></label>
        <label class="chip"><input type="checkbox" class="extra" name="extra_balconi" value="balconi" data-minutes="20" data-price="10"><span>Balconi / verande</span></label>
        <label class="chip"><input type="checkbox" class="extra" name="extra_stiratura" value="stiratura" data-minutes="30" data-price="12"><span>Stiratura</span></label>
        <label class="chip"><input type="checkbox" class="extra" name="extra_kit_ospiti" value="kit_ospiti" data-minutes="5" data-price="4"><span>Kit cortesia ospiti</span></label>
      </div>

      <div class="card mt-24" id="box-stima" aria-live="polite">
        <div class="grid-3">
          <div><div class="muted">Durata stimata</div><div class="h4" id="durata">—</div></div>
          <div><div class="muted">Costo del servizio B&B Clean</div><div class="h4" id="costo">—</div></div>
          <div><div class="muted">Extra selezionati</div><div id="extra-riepilogo">Nessuno</div></div>
        </div>
        <small class="muted">La stima è indicativa e può variare in base alle esigenze reali. Vedrai il dettaglio prima della conferma.</small>
      </div>

      <div class="actions mt-24">
        <button type="submit" id="btn-prosegui" class="btn primary">Prosegui</button>
        <a href="/servizi.html" class="btn">I nostri servizi</a>
      </div>
    </form>
  </main>

  <footer class="container" style="border-top:1px solid var(--ring);margin-top:28px;padding:16px 0;color:var(--muted);font-size:14px">
    © 2025 B&B Clean — Il tuo tempo è il nostro lavoro!
  </footer>

  <!-- Script comune -->
  <script src="/assets/js/site.js" defer></script>

  <!-- Auth0: SDK (locale) + Config + Helper + Guard + Stato utente -->
  <script src="/assets/js/vendor/auth0-spa-js.production.js"></script>
  <script src="/assets/js/auth-config.js"></script>
  <script src="/assets/js/auth.js"></script>
  <script src="/assets/js/guard.js"></script>
  <script src="/assets/js/menu-auth.js"></script>

  <!-- Prefill + calcolo extras + stima + Netlify Forms helper -->
  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const euro = v => (v==null || isNaN(v)) ? '—' :
        new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(v);
      const roundHalf = num => Math.round(num*2)/2;

      // RIEPILOGO E PREFILL
      document.addEventListener('DOMContentLoaded', async ()=>{
        const p = new URLSearchParams(location.search);
        const regione = p.get('regione')||'';
        const citta = p.get('citta')||'';
        const indirizzo = p.get('indirizzo')||'';
        const mq = p.get('mq')||'';

        if (mq) { const el = $('#mq'); if (el) el.value = mq; }

        // Hidden per Netlify
        $('#nf-regione').value = regione;
        $('#nf-citta').value = citta;
        $('#nf-indirizzo').value = indirizzo;

        // Email da Auth (se disponibile)
        try{
          await window.Auth.ensureReady();
          if (await window.Auth.isAuthenticated()){
            const user = await window.Auth.getUser();
            if (user && user.email) $('#nf-email').value = user.email;
          }
        }catch(_){}

        // Riepilogo box
        const items = [];
        if (regione) items.push(['Regione', regione]);
        if (citta) items.push(['Città', citta]);
        if (indirizzo) items.push(['Indirizzo', indirizzo]);
        if (items.length){
          const wrap = $('#summary-address');
          const kv = $('#summary-kv');
          kv.innerHTML = items.map(([k,v])=>(
            `<div class="kv"><div class="k">${k}</div><div class="v">${v}</div></div>`
          )).join('');
          wrap.style.display = 'block';
        }
      });

      // CALCOLO STIMA LOCALE (semplice)
      const mph = 35;
      function updateStima(){
        const mq = parseFloat($('#mq').value) || 0;
        const ore = Math.max(1, roundHalf(mq / mph));
        $('#durata').textContent = `${ore.toString().replace('.',',')} h`;

        const extras = Array.from(document.querySelectorAll('.extra:checked'));
        const extraSum = extras.reduce((acc,el)=> acc + (parseFloat(el.dataset.price)||0), 0);
        const baseRate = 18; // es. media
        const costo = (ore * baseRate) + extraSum;
        $('#costo').textContent = euro(costo);

        const riepilogo = extras.length ? extras.map(e => e.value.replace('_',' ')).join(', ') : 'Nessuno';
        $('#extra-riepilogo').textContent = riepilogo;

        // Compila hidden "extras" per Netlify
        $('#nf-extras').value = extras.map(e=>e.value).join(',');
      }

      document.addEventListener('change', e=>{
        if (e.target && (e.target.id==='mq' || e.target.classList.contains('extra'))){
          updateStima();
        }
      });
      document.addEventListener('input', e=>{
        if (e.target && e.target.id==='mq'){ updateStima(); }
      });
      document.addEventListener('DOMContentLoaded', updateStima);
    })();
  </script>
</body>
</html>
