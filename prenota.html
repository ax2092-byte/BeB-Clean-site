<!-- FILE: /prenota.html  (Aggiornato: Regioni select, Città da comuni.json, geocode lat/lon) -->
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prenota — B&B Clean</title>
  <meta name="description" content="Prenota una pulizia per casa o B&B. Stima trasparente prima della conferma.">
  <link rel="icon" href="/assets/img/favicon-32.png">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <style>
    :root{--brand:#0f9e9e;--brand-ink:#0a6f6f;--ink:#111827;--muted:#6b7280;--ring:#e5e7eb;--card:#f9fafb;--surface:#fff}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;color:var(--ink);background:var(--surface)}
    .container{width:min(1000px,92%);margin:0 auto}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
    .topbar .left{display:flex;align-items:center;gap:10px}
    .back-arrow{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:999px;border:1px solid var(--ring);text-decoration:none;color:var(--ink)}
    .back-arrow:hover{background:#f3f4f6}
    .logo{height:32px;display:block}
    .mainnav a{text-decoration:none;color:var(--ink);font-weight:700;margin-left:16px;padding:8px 12px;border-radius:12px}
    .mainnav a:hover{background:#f3f4f6}
    .mainnav a.active{background:#e6f5f5;color:var(--brand-ink)}
    .hero{padding:36px 0 8px}
    .hero h1{font-size:clamp(26px,4vw,36px);margin:0 0 8px}
    .hero .sub{color:var(--muted);margin:0}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:18px}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px}
    .field label{display:block;margin:8px 0 6px;font-weight:600}
    .field input,.field select{width:100%;padding:12px;border:1px solid var(--ring);border-radius:12px}
    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer}
    .muted{color:var(--muted)}
    .h4{font-size:22px;font-weight:800}
    .h5{font-size:18px;margin:14px 0 6px}
    .mt-24{margin-top:24px}
    .actions{display:flex;gap:12px;flex-wrap:wrap}
    .btn{display:inline-block;border:1px solid var(--ring);padding:12px 16px;border-radius:14px;text-decoration:none;font-weight:700}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.primary:disabled{opacity:.6;cursor:not-allowed}
    .summary-kv{display:flex;flex-wrap:wrap;gap:10px 16px}
    .summary-kv .kv{background:#fff;border:1px solid var(--ring);border-radius:12px;padding:8px 10px}
    .summary-kv .kv .k{color:var(--muted);font-size:12px}
    .summary-kv .kv .v{font-weight:700}
    .verified{font-size:12px;color:#065f46;background:#d1fae5;border:1px solid #10b981;padding:4px 8px;border-radius:999px;display:none}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="topbar container" role="banner">
    <div class="left">
      <a id="back-link" class="back-arrow" href="#back" aria-label="Torna alla pagina precedente">←</a>
      <a href="/index.html" aria-label="B&B Clean — Home">
        <img class="logo" src="/assets/img/bbclean-logo-primary.png" alt="B&B Clean">
      </a>
    </div>
    <nav class="mainnav" aria-label="Menu principale">
      <a href="/index.html" data-page="home">HOME</a>
      <a href="/prenota.html" data-page="prenota">PRENOTA</a>
      <a href="/servizi.html" data-page="servizi">I NOSTRI SERVIZI</a>
      <a href="/partner.html" data-page="partner">DIVENTA PARTNER</a>
    </nav>
  </header>

  <!-- HERO -->
  <section class="hero container">
    <h1>Prenota una pulizia</h1>
    <p class="sub">Conferma i dettagli, scegli gli extra e invia la richiesta.</p>
  </section>

  <!-- RIEPILOGO -->
  <section class="container">
    <div class="card" id="summary-address" style="display:none">
      <div class="summary-kv" id="summary-kv"></div>
      <span id="addr-verified" class="verified">Indirizzo verificato ✓</span>
    </div>
  </section>

  <!-- FORM NETLIFY -->
  <main class="container">
    <form id="form-prenota" class="card"
          name="prenota"
          method="POST"
          action="/success.html"
          data-netlify="true"
          netlify-honeypot="bot-field">
      <input type="hidden" name="form-name" value="prenota">
      <input type="hidden" name="bot-field">

      <!-- hidden tecnici -->
      <input type="hidden" name="partner_id" id="nf-partner-id">
      <input type="hidden" name="prezzi_fonte" id="nf-prezzi-fonte" value="consigliati">
      <input type="hidden" name="extras" id="nf-extras">
      <input type="hidden" name="email" id="nf-email">
      <input type="hidden" name="lat" id="nf-lat">
      <input type="hidden" name="lon" id="nf-lon">

      <h2 class="h5">Dati dell’alloggio</h2>
      <div class="grid-2">
        <div class="field">
          <label for="regione">Regione</label>
          <select id="regione" name="regione" required>
            <option value="">Seleziona…</option>
            <option>Abruzzo</option>
            <option>Basilicata</option>
            <option>Calabria</option>
            <option>Campania</option>
            <option>Emilia-Romagna</option>
            <option>Friuli-Venezia Giulia</option>
            <option>Lazio</option>
            <option>Liguria</option>
            <option>Lombardia</option>
            <option>Marche</option>
            <option>Molise</option>
            <option>Piemonte</option>
            <option>Puglia</option>
            <option>Sardegna</option>
            <option>Sicilia</option>
            <option>Toscana</option>
            <option>Trentino-Alto Adige</option>
            <option>Umbria</option>
            <option>Valle d'Aosta</option>
            <option>Veneto</option>
          </select>
        </div>
        <div class="field">
          <label for="citta">Città</label>
          <input list="comuni-list" id="citta" name="citta" placeholder="Es. Nuoro" required>
          <datalist id="comuni-list"></datalist>
        </div>
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="indirizzo">Indirizzo</label>
          <input type="text" id="indirizzo" name="indirizzo" placeholder="Es. Via Bologna" required>
        </div>
        <div class="field">
          <label for="civico">Numero civico</label>
          <input type="text" id="civico" name="civico" placeholder="Es. 10" required>
        </div>
      </div>

      <div class="grid-3">
        <div class="field">
          <label for="mq">Metri quadri (mq)</label>
          <input type="number" id="mq" name="mq" min="10" max="400" step="1" placeholder="es. 70" required>
        </div>
        <div class="field">
          <label for="bagni">Quantità di bagni</label>
          <input type="number" id="bagni" name="bagni" min="1" max="10" step="1" placeholder="es. 1" required>
        </div>
        <div class="field">
          <label for="cucina">Cucina</label>
          <select id="cucina" name="cucina" required>
            <option value="">Seleziona…</option>
            <option value="si">Sì</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div class="field">
          <label for="camere_letto">Camere da letto</label>
          <input type="number" id="camere_letto" name="camere_letto" min="1" max="10" step="1" placeholder="es. 2" required>
        </div>
        <div class="field">
          <label for="stanze">Numero di stanze (opzionale)</label>
          <input type="number" id="stanze" name="stanze" min="1" max="15" step="1" placeholder="es. 4">
        </div>
      </div>

      <h2 class="h5 mt-24">Extra su richiesta</h2>
      <div id="extra-list" class="chips">
        <label class="chip">
          <input type="checkbox" class="extra" value="cambio_biancheria" data-minutes="15" data-price="4">
          <span data-label="cambio_biancheria">Cambio biancheria · 4€</span>
        </label>

        <label class="chip">
          <input type="checkbox" class="extra" value="forno" data-minutes="20" data-price="7.5">
          <span data-label="forno">Forno · 7,50€</span>
        </label>

        <label class="chip">
          <input type="checkbox" class="extra" value="frigo" data-minutes="15" data-price="6">
          <span data-label="frigo">Frigo · 6€</span>
        </label>

        <label class="chip">
          <input type="checkbox" class="extra" value="vetri" data-minutes="25" data-price="8">
          <span data-label="vetri">Vetri e infissi · 8€</span>
        </label>

        <label class="chip">
          <input type="checkbox" class="extra" value="balconi" data-minutes="20" data-price="12">
          <span data-label="balconi">Balconi / verande · 12€</span>
        </label>
      </div>
      <div class="muted" id="price-note" style="margin-top:6px">
        Prezzi extra consigliati da B&B Clean. Il partner può applicare prezzi propri.
      </div>

      <div class="card mt-24" id="box-stima" aria-live="polite">
        <div class="grid-3">
          <div><div class="muted">Durata stimata</div><div class="h4" id="durata">—</div></div>
          <div><div class="muted">Costo del servizio B&B Clean</div><div class="h4" id="costo">—</div></div>
          <div><div class="muted">Extra selezionati</div><div id="extra-riepilogo">Nessuno</div></div>
        </div>
        <small class="muted">La stima è indicativa e può variare in base alle esigenze reali. Vedrai il dettaglio prima della conferma.</small>
      </div>

      <div class="actions mt-24">
        <button type="submit" id="btn-prosegui" class="btn primary">Prosegui</button>
        <a href="/servizi.html" class="btn">I nostri servizi</a>
      </div>
    </form>
  </main>

  <footer class="container" style="border-top:1px solid var(--ring);margin-top:28px;padding:16px 0;color:var(--muted);font-size:14px">
    © 2025 B&B Clean — Il tuo tempo è il nostro lavoro!
  </footer>

  <!-- Script comune -->
  <script src="/assets/js/site.js" defer></script>

  <!-- Auth0: SDK (locale) + Config + Helper + Guard + Stato utente -->
  <script src="/assets/js/vendor/auth0-spa-js.production.js"></script>
  <script src="/assets/js/auth-config.js"></script>
  <script src="/assets/js/auth.js"></script>
  <script src="/assets/js/guard.js"></script>
  <script src="/assets/js/menu-auth.js"></script>

  <!-- Prefill + comuni.json + geocode + stima + prezzi partner -->
  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const euro = v => (v==null || isNaN(v)) ? '—' :
        new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(v);
      const roundHalf = num => Math.round(num*2)/2;

      // Prezzi consigliati (override dal partner se disponibile)
      const defaultExtraPrices = {
        cambio_biancheria: 4,
        forno: 7.5,
        frigo: 6,
        vetri: 8,
        balconi: 12
      };

      function labelText(key, price){
        const map = {
          cambio_biancheria: 'Cambio biancheria',
          forno: 'Forno',
          frigo: 'Frigo',
          vetri: 'Vetri e infissi',
          balconi: 'Balconi / verande'
        };
        return map[key] + ' · ' + euro(price).replace(' €','€');
      }

      function applyExtraPrices(prices, sourceLabel){
        $$('.extra').forEach(inp=>{
          const key = inp.value;
          const p = (prices && prices[key] != null) ? Number(prices[key]) : defaultExtraPrices[key];
          inp.dataset.price = String(p);
          const lab = document.querySelector('[data-label="'+key+'"]');
          if (lab) lab.textContent = labelText(key, p);
        });
        if (sourceLabel){ $('#price-note').textContent = sourceLabel; }
        updateStima();
      }

      // STIMA (coerente con stima.html)
      const MPH = 35;      // mq/ora
      const BASE_RATE = 18; // €/h
      function updateStima(){
        const mq = parseFloat($('#mq').value) || 0;
        const ore = Math.max(1, roundHalf(mq / MPH));
        $('#durata').textContent = `${String(ore).replace('.',',')} h`;

        const extras = $$('.extra:checked');
        const extraSum = extras.reduce((acc,el)=> acc + (parseFloat(el.dataset.price)||0), 0);
        const costo = (ore * BASE_RATE) + extraSum;
        $('#costo').textContent = euro(costo);

        const riepilogo = extras.length ? extras.map(e => {
          const key = e.value; const p = parseFloat(e.dataset.price)||0;
          return labelText(key, p);
        }).join(', ') : 'Nessuno';
        $('#extra-riepilogo').textContent = riepilogo;

        // hidden "extras"
        $('#nf-extras').value = extras.map(e=>{
          const key = e.value; const p = parseFloat(e.dataset.price)||0;
          return `${key}:${p}`;
        }).join('; ');
      }
      document.addEventListener('change', e=>{
        if (e.target && (e.target.id==='mq' || e.target.classList.contains('extra'))) updateStima();
      });
      document.addEventListener('input', e=>{
        if (e.target && e.target.id==='mq') updateStima();
      });

      // Prefill da query + email utente + partner prices
      document.addEventListener('DOMContentLoaded', async ()=>{
        const p = new URLSearchParams(location.search);
        const regioneQS = p.get('regione')||'';
        const cittaQS = p.get('citta')||'';
        const indirizzoQS = p.get('indirizzo')||'';
        const civicoQS = p.get('civico')||'';
        const mqQS = p.get('mq')||'';

        // Regioni: seleziona se presente in QS (case-insensitive)
        if (regioneQS){
          const opts = $$('#regione option');
          const match = opts.find(o => o.value.toLowerCase() === regioneQS.toLowerCase());
          if (match) $('#regione').value = match.value;
        }
        if (cittaQS) $('#citta').value = cittaQS;
        if (indirizzoQS) $('#indirizzo').value = indirizzoQS;
        if (civicoQS) $('#civico').value = civicoQS;
        if (mqQS) $('#mq').value = mqQS;

        // Email da Auth
        try{
          await window.Auth.ensureReady();
          if (await window.Auth.isAuthenticated()){
            const user = await window.Auth.getUser();
            if (user && user.email) $('#nf-email').value = user.email;
          }
        }catch(_){}

        // Prezzi consigliati default
        applyExtraPrices(defaultExtraPrices, 'Prezzi extra consigliati da B&B Clean. Il partner può applicare prezzi propri.');

        // Override da partner (pid in QS)
        const pid = p.get('pid') || p.get('partner') || sessionStorage.getItem('stima_partner_id') || '';
        if (pid){
          try{
            const res = await fetch('/assets/data/partner.json', {cache:'no-store'});
            const partners = await res.json();
            const partner = Array.isArray(partners) ? partners.find(x => String(x.id||x.ID||x.slug||'') === String(pid)) : null;
            if (partner){
              $('#nf-partner-id').value = String(pid);
              const partnerPrices = partner.extra_prices || partner.extras || null;
              if (partnerPrices){
                applyExtraPrices(partnerPrices, 'Prezzi extra applicati dal partner.');
                $('#nf-prezzi-fonte').value = 'partner';
              }
            }
          }catch(_){}
        }

        // Carica comuni.json nel datalist (prima percorso assets, poi fallback root)
        loadComuniDatalist();
        updateSummaryBox();
        updateStima();
      });

      async function loadComuniDatalist(){
        const dl = $('#comuni-list');
        if (!dl) return;
        let data = null;
        for (const path of ['/assets/data/comuni.json','/comuni.json']){
          try{
            const res = await fetch(path, {cache:'no-store'});
            if (res.ok){ data = await res.json(); break; }
          }catch(_){}
        }
        if (!Array.isArray(data)) return;
        // Attenzione: usiamo value=nome, label=“NOME (PR)”
        const frag = document.createDocumentFragment();
        data.forEach(c=>{
          const opt = document.createElement('option');
          opt.value = (c.nome || c.Nome || '').toString();
          const prov = (c.provincia || c.Provincia || '').toString();
          if (prov) opt.setAttribute('label', opt.value + ' (' + prov + ')');
          frag.appendChild(opt);
        });
        dl.innerHTML = '';
        dl.appendChild(frag);
      }

      function updateSummaryBox(){
        const regione = $('#regione').value || '';
        const citta = $('#citta').value || '';
        const indirizzo = $('#indirizzo').value || '';
        const civico = $('#civico').value || '';
        const items = [];
        if (regione) items.push(['Regione', regione]);
        if (citta) items.push(['Città', citta]);
        if (indirizzo || civico) items.push(['Indirizzo', (indirizzo||'') + (civico? ' ' + civico : '')]);
        const wrap = $('#summary-address');
        const kv = $('#summary-kv');
        if (items.length){
          kv.innerHTML = items.map(([k,v])=>(
            `<div class="kv"><div class="k">${k}</div><div class="v">${v}</div></div>`
          )).join('');
          wrap.style.display = 'block';
        } else {
          wrap.style.display = 'none';
        }
      }

      // Aggiorna riepilogo live
      ['regione','citta','indirizzo','civico'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateSummaryBox);
        if (el) el.addEventListener('change', updateSummaryBox);
      });

      // Geocode prima del submit → salva lat/lon + badge verificato
      async function geocodeAddress(fullAddress){
        const url = '/.netlify/functions/geocode?q=' + encodeURIComponent(fullAddress);
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('Geocode fallito');
        return res.json(); // {lat, lon, display_name}
      }

      $('#form-prenota').addEventListener('submit', async function(e){
        e.preventDefault();
        $('#btn-prosegui').disabled = true;

        const regione = $('#regione').value.trim();
        const citta = $('#citta').value.trim();
        const indirizzo = $('#indirizzo').value.trim();
        const civico = $('#civico').value.trim();

        if (!regione || !citta || !indirizzo || !civico){
          alert('Compila tutti i campi di indirizzo (Regione, Città, Indirizzo e Numero civico).');
          $('#btn-prosegui').disabled = false;
          return;
        }

        const fullAddress = `${indirizzo} ${civico}, ${citta}, ${regione}, Italia`;

        try{
          const geo = await geocodeAddress(fullAddress);
          $('#nf-lat').value = geo.lat || '';
          $('#nf-lon').value = geo.lon || '';
          const badge = $('#addr-verified');
          if (badge) badge.style.display = 'inline-block';
        }catch(_){
          alert('Non sono riuscito a verificare l’indirizzo. Controlla i dati e riprova.');
          $('#btn-prosegui').disabled = false;
          return;
        }

        // invia il form
        e.target.submit();
      });

      // Freccia indietro
      const back = document.getElementById('back-link');
      if (back){
        back.addEventListener('click', function(e){
          e.preventDefault();
          if (history.length > 1) history.back();
          else location.href = '/index.html';
        });
      }
    })();
  </script>
</body>
</html>
